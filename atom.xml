<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Kay Wu&#39;s blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://kaywu.xyz/"/>
  <updated>2017-09-17T15:40:42.000Z</updated>
  <id>http://kaywu.xyz/</id>
  
  <author>
    <name>Kay Wu</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>微信开发总结</title>
    <link href="http://kaywu.xyz/2017/09/10/wechat-development/"/>
    <id>http://kaywu.xyz/2017/09/10/wechat-development/</id>
    <published>2017-09-10T07:47:00.000Z</published>
    <updated>2017-09-17T15:40:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近开发了基于微信的相关项目，主要是微信的网页开发、微信支付以及发送消息这块的内容。项目本身没什么难度，但由于微信封闭的体系、混乱的配置以及分散的文档，爬了不少的坑，这里总结下经验。</p><h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p>先说说微信的文档。微信的文档不是统一的，比如公众平台技术文档在<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1445241432" target="_blank" rel="external">一个网站</a>，而支付文档在<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_1" target="_blank" rel="external">另一个网站</a>，但支付文档所使用的 js 的相关文档又在前一个网站。除此之外，还有<a href="https://mp.weixin.qq.com/debug/wxadoc/dev/index.html" target="_blank" rel="external">小程序文档</a>、<a href="https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&amp;t=resource/res_list&amp;verify=1&amp;id=open1419318292&amp;token=&amp;lang=zh_CN" target="_blank" rel="external">开放平台文档</a>。从这混乱的文档相信你也能或多或少体会到开发的难处。</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>出于安全性（更多是封闭性）的考虑，微信的配置繁琐且复杂，这里我把整个流程都记录下来以供参考。<br>首先登录公众平台，在开发-基本配置里获得 <code>AppSecret</code> 并保存下来，之后网站就不会再显示开发者密码，只能重置。<br>同样在该页面，配置 IP 白名单。如果你需要接收用户公众号的消息以及事件推送，同一页面添加服务器配置。<br>然后，在设置-公众号设置-功能设置，按照说明对业务域名、JS 接口安全域名、网页授权域名进行设置。<br>如果有微信支付的需求，去<a href="https://pay.weixin.qq.com" target="_blank" rel="external">微信商户平台</a>，商户平台-产品中心-开发配置中设置公众号支付的授权目录。注意，授权目录必须是发起支付网址的上一级目录。举例来说，<br>发起支付的网址为 <code>www.xxx.com/orders/22/pay</code>，那么支付目录就必须为 <code>www.xxx.com/orders/22/</code>，填 <code>www.xxx.com/</code> 或者 <code>www.xxx.com/orders/</code> 都是不行的。再加上支付的授权目录只能填 5 个，发起支付的域名得注意设计。</p><p>PS: 没有公众号的朋友可以通过微信的<a href="https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login" target="_blank" rel="external">测试号</a>来试验除微信支付以外大部分的功能。</p><a id="more"></a><h2 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h2><p>先简单地介绍下常见的开发概念。</p><ul><li>access_token：通过 AppID 和 AppSecret 获得，是公众号的全局唯一接口调用凭据，调用各接口时都需使用。由于是全局唯一，所以建议正式环境、测试环境使用两个公众号，不然会各自冲突。</li><li>jsapi_ticket：通过 access_token 获取，是公众号用于调用微信 JS 接口的临时票据。网页在使用 JS-SDK 的时需要先调用 config 接口，其中的参数 signature 需要用到 jsapi_ticket 生成。</li></ul><p>注意下 access_token、jsapi_ticket 有效期都为 2 小时，且每天的调用次数有限，需要做全局缓存以及过期自动刷新的处理。</p><p>我开发的项目使用了 Rails + <a href="https://github.com/Eric-Guo/wechat" target="_blank" rel="external">wechat gem</a> + <a href="https://github.com/jasl/wx_pay" target="_blank" rel="external">wx_pay gem</a>。wechat gem 自动管理 access_token、jsapi_ticket，封装了公众号的接口并提供了授权地址、调用 JS-SDK 的便捷方法，wx_pay gem 封装了支付相关的接口。强烈推荐使用，能够省去不少功夫。</p><h3 id="网页授权"><a href="#网页授权" class="headerlink" title="网页授权"></a>网页授权</h3><p>微信的网页授权也是常见的 OAuth 2.0，与其他网页不同的是有两个不同的 scope。</p><ul><li>以 snsapi_base 为 scope 发起的网页授权，可以获取进入页面的用户的openid，静默授权并自动跳转到回调页的。用户感知的就是直接进入了回调页。</li><li>以 snsapi_userinfo 为 scope 发起的网页授权，可以获取用户的基本信息。但这种授权需要用户手动同意，并且由于用户同意过，所以无须关注，就可在授权后获取该用户的基本信息。不同于用户管理类接口中的“获取用户基本信息接口”，需要该用户关注了公众号后，才能调用成功。</li></ul><h3 id="微信支付"><a href="#微信支付" class="headerlink" title="微信支付"></a>微信支付</h3><p>在调用微信支付前，需要从后端发起 unifiedorder 统一下单请求获取到 prepay_id，通过 prepay_id、AppID、商品平台的 key 等参数生成签名，最后调用 wx.chooseWXPay 发起微信支付。<br>注意，生成支付签名这边有很多的坑，比如 timestamp 在 wx.chooseWxPay 里是小写，而在生成签名时使用的是 timeStamp。尽量使用成熟的库来避免这种不知所谓的坑。<br>统一下单请求时会要求传入参数 notify_url，这个是异步接受微信支付结果通知的回调地址。注意该地址不能携带参数。举例来说 <code>https://www.xxx.com?a=1</code>，回调时 <code>a=1</code>会被省略。</p><h3 id="发送消息"><a href="#发送消息" class="headerlink" title="发送消息"></a>发送消息</h3><p>发送消息主要有两大部分，其一是模板消息。<br>微信对模板消息有着严格的管理，所在行业有相应的模板库，你只能从模板库里选择添加到我的模板，向模板库里新增模板需要经过审核。<br>新增模板时最好记录下模板编号，因为添加到我的模板后，只能看见模板 ID，看不到原始的模板编号。而每一个公众号添加相同的模板时对应的模板 ID 是不一样的。</p><p>除模板消息之外，还有客服消息。客服消息又分文本消息、图片消息、语音消息等。文档里虽然没提，文本消息支持 <code>&lt;br&gt;</code> 换行、<code>&lt;a href=&quot;#&quot;&gt;</code> 超链接这些功能。</p><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>刚开始开发微信时有一个很头疼的事，怎么才能做到本机调试呢。这里说下我个人的方法。<br>假设开发网站的域名是 <code>http://www.example.com</code>，通过修改 hosts、nginx 转发等方法，将 <code>http://www.example.com</code> 映射到本地端口如 <code>http://localhost:3000</code> 上。之后通过 <a href="https://mp.weixin.qq.com/debug/wxadoc/dev/devtools/download.html" target="_blank" rel="external">微信开发者工具</a> 就可以本机调试了。<br>但是微信开发者工具也有其限制，比如不能模拟微信支付，这时候就需要用到手机了。手机通过 charles 代理，由于本机 <code>http://www.example.com</code> 的请求已经转发到本地端口，也就实现了本机调试。<br>同时还有 TBS Studio，可以通过 USB 连接手机实现真机调试。实际使用感觉效率一般，建议补充使用。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1445241432" target="_blank" rel="external">微信公众平台技术文档</a></li><li><a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_1" target="_blank" rel="external">微信支付开发文档</a></li></ul><!-- 公众平台文档 --><!-- 微信支付文档 --><!-- 小程序文档 --><!-- 开放平台文档 --><!-- 微信测试号 --><!-- 微信商户平台 --><!-- wechat gem --><!-- wx_pay gem --><!-- 支付签名算法 --><!-- 微信开发工具 -->]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近开发了基于微信的相关项目，主要是微信的网页开发、微信支付以及发送消息这块的内容。项目本身没什么难度，但由于微信封闭的体系、混乱的配置以及分散的文档，爬了不少的坑，这里总结下经验。&lt;/p&gt;
&lt;h2 id=&quot;文档&quot;&gt;&lt;a href=&quot;#文档&quot; class=&quot;headerlink&quot; title=&quot;文档&quot;&gt;&lt;/a&gt;文档&lt;/h2&gt;&lt;p&gt;先说说微信的文档。微信的文档不是统一的，比如公众平台技术文档在&lt;a href=&quot;https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;amp;id=mp1445241432&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;一个网站&lt;/a&gt;，而支付文档在&lt;a href=&quot;https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_1&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;另一个网站&lt;/a&gt;，但支付文档所使用的 js 的相关文档又在前一个网站。除此之外，还有&lt;a href=&quot;https://mp.weixin.qq.com/debug/wxadoc/dev/index.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;小程序文档&lt;/a&gt;、&lt;a href=&quot;https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&amp;amp;t=resource/res_list&amp;amp;verify=1&amp;amp;id=open1419318292&amp;amp;token=&amp;amp;lang=zh_CN&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;开放平台文档&lt;/a&gt;。从这混乱的文档相信你也能或多或少体会到开发的难处。&lt;/p&gt;
&lt;h2 id=&quot;配置&quot;&gt;&lt;a href=&quot;#配置&quot; class=&quot;headerlink&quot; title=&quot;配置&quot;&gt;&lt;/a&gt;配置&lt;/h2&gt;&lt;p&gt;出于安全性（更多是封闭性）的考虑，微信的配置繁琐且复杂，这里我把整个流程都记录下来以供参考。&lt;br&gt;首先登录公众平台，在开发-基本配置里获得 &lt;code&gt;AppSecret&lt;/code&gt; 并保存下来，之后网站就不会再显示开发者密码，只能重置。&lt;br&gt;同样在该页面，配置 IP 白名单。如果你需要接收用户公众号的消息以及事件推送，同一页面添加服务器配置。&lt;br&gt;然后，在设置-公众号设置-功能设置，按照说明对业务域名、JS 接口安全域名、网页授权域名进行设置。&lt;br&gt;如果有微信支付的需求，去&lt;a href=&quot;https://pay.weixin.qq.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;微信商户平台&lt;/a&gt;，商户平台-产品中心-开发配置中设置公众号支付的授权目录。注意，授权目录必须是发起支付网址的上一级目录。举例来说，&lt;br&gt;发起支付的网址为 &lt;code&gt;www.xxx.com/orders/22/pay&lt;/code&gt;，那么支付目录就必须为 &lt;code&gt;www.xxx.com/orders/22/&lt;/code&gt;，填 &lt;code&gt;www.xxx.com/&lt;/code&gt; 或者 &lt;code&gt;www.xxx.com/orders/&lt;/code&gt; 都是不行的。再加上支付的授权目录只能填 5 个，发起支付的域名得注意设计。&lt;/p&gt;
&lt;p&gt;PS: 没有公众号的朋友可以通过微信的&lt;a href=&quot;https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;测试号&lt;/a&gt;来试验除微信支付以外大部分的功能。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Rails" scheme="http://kaywu.xyz/tags/Rails/"/>
    
      <category term="微信" scheme="http://kaywu.xyz/tags/%E5%BE%AE%E4%BF%A1/"/>
    
  </entry>
  
  <entry>
    <title>互联网创业核心技术：构建可伸缩的 Web 应用</title>
    <link href="http://kaywu.xyz/2017/07/13/core-tech/"/>
    <id>http://kaywu.xyz/2017/07/13/core-tech/</id>
    <published>2017-07-13T09:23:30.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>《互联网创业核心技术：构建可伸缩的 Web 应用》整本书围绕“可伸缩”三个字，对 Web 应用的每一层展开了全面细致的解说。<br>如果你和我一样，对负载均衡、水平伸缩之类的概念不是很了解，或者不清楚它在整个架构中的使用，那么你应该来读下这本书。<br>读完之后你会发现架构这东西是有迹可循的，是围绕一系列基本的原则建立起来的。</p><p>一图胜千言，这本书不仅有着易懂的语言，而且有大量简洁的示意图。<br><a id="more"></a><br><img src="/img/core_tech.png" alt=""><br>上图大致说明了本书涉及的内容，从前后端设计、存储设计，再到消息队列和缓存等的使用场景。</p><p>我读到这本书时颇有意外之喜，毕竟这是凑单的书，可见这书挺冷门的。在这里推荐一下，希望能有更多的人读到。<br>可以搭配 <a href="https://www.youtube.com/watch?v=-W9F__D3oY4" target="_blank" rel="external">Scalability Harvard Web Development (需翻墙)</a> 一起使用。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;《互联网创业核心技术：构建可伸缩的 Web 应用》整本书围绕“可伸缩”三个字，对 Web 应用的每一层展开了全面细致的解说。&lt;br&gt;如果你和我一样，对负载均衡、水平伸缩之类的概念不是很了解，或者不清楚它在整个架构中的使用，那么你应该来读下这本书。&lt;br&gt;读完之后你会发现架构这东西是有迹可循的，是围绕一系列基本的原则建立起来的。&lt;/p&gt;
&lt;p&gt;一图胜千言，这本书不仅有着易懂的语言，而且有大量简洁的示意图。&lt;br&gt;
    
    </summary>
    
      <category term="读书笔记" scheme="http://kaywu.xyz/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="读书笔记" scheme="http://kaywu.xyz/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>FactoryGirl 源码浅析</title>
    <link href="http://kaywu.xyz/2017/06/28/factory-girl-analysis/"/>
    <id>http://kaywu.xyz/2017/06/28/factory-girl-analysis/</id>
    <published>2017-06-28T09:21:20.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>FactoryGirl 是我个人十分喜欢的 Gem，它能很方便地模拟测试数据。使用技巧可见 <a href="http://www.jianshu.com/p/cca80f341d77" target="_blank" rel="external">FactoryGirl 技巧</a>。出于兴趣我研究了下它的源代码，说实话比想象得要复杂。由于 FactoryGirl 配置的灵活性以及 Ruby 本身的语言特点，使得它代码整体上比较飘逸。<br>这里我会对它最基础的方法进行分析，版本为 4.8.0。</p><h3 id="FactoryGirl-define"><a href="#FactoryGirl-define" class="headerlink" title="FactoryGirl.define"></a>FactoryGirl.define</h3><p>先从定义 Factory 开始。下面的代码定义了名为 user 的 Factory，它有一个名为 name 的属性，值为 Kay。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">FactoryGirl.define <span class="keyword">do</span></div><div class="line">  factory <span class="symbol">:user</span> <span class="keyword">do</span></div><div class="line">    name <span class="string">'Kay'</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><a id="more"></a><p>我们先找到 FactoryGirl.define 的入口，在 syntax/default.rb 里。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># syntax/default.rb</span></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">FactoryGirl</span></span></div><div class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Syntax</span></span></div><div class="line">    <span class="class"><span class="keyword">module</span> <span class="title">Default</span></span></div><div class="line">      <span class="keyword">include</span> Methods</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">def</span> <span class="title">define</span><span class="params">(&amp;block)</span></span></div><div class="line">        DSL.run(block)</div><div class="line">      <span class="keyword">end</span></div><div class="line"></div><div class="line">      <span class="class"><span class="keyword">class</span> <span class="title">DSL</span></span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">factory</span><span class="params">(name, options = &#123;&#125;, &amp;block)</span></span></div><div class="line">          factory = Factory.new(name, options)</div><div class="line">          proxy = FactoryGirl::DefinitionProxy.new(factory.definition)</div><div class="line">          proxy.instance_eval(&amp;block) <span class="keyword">if</span> block_given?</div><div class="line"></div><div class="line">          FactoryGirl.register_factory(factory)</div><div class="line"></div><div class="line">          proxy.child_factories.each <span class="keyword">do</span> <span class="params">|(child_name, child_options, child_block)|</span></div><div class="line">            parent_factory = child_options.delete(<span class="symbol">:parent</span>) <span class="params">||</span> name</div><div class="line">            factory(child_name, child_options.merge(<span class="symbol">parent:</span> parent_factory), &amp;child_block)</div><div class="line">          <span class="keyword">end</span></div><div class="line">        <span class="keyword">end</span></div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">run</span><span class="params">(block)</span></span></div><div class="line">          new.instance_eval(&amp;block)</div><div class="line">        <span class="keyword">end</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line">  extend Syntax::Default</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>从上面的代码分析可得，define 会调用 DSL.run，之后调用了 DSL#factory 方法，传入的参数 name 为 <code>:user</code>，block 为 <code>{ name &#39;Kay&#39; }</code>。我们重点看 factory 方法其中 4 行：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># DSL#factory</span></div><div class="line">factory = Factory.new(name, options)</div><div class="line">proxy = FactoryGirl::DefinitionProxy.new(factory.definition)</div><div class="line">proxy.instance_eval(&amp;block) <span class="keyword">if</span> block_given?</div><div class="line"></div><div class="line">FactoryGirl.register_factory(factory)</div></pre></td></tr></table></figure></p><p>首先，会创建一个新的 Factory 对象，然后通过代理类 FactoryGirl::DefinitionProxy 对其进行封装，并执行其中的 block，最后注册这个 factory。其中 <code>proxy.instance_eval(&amp;block) if block_given?</code> 是属性赋值的关键。</p><p><code>{ name &#39;Kay&#39; }</code> 会调用 FactoryGirl::DefinitionProxy 的 name 方法，但由于代理类没有该方法，最终会执行 method_missing，而该方法实现了赋值的逻辑。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(name, *args, &amp;block)</span></span></div><div class="line">  <span class="keyword">if</span> args.empty? &amp;&amp; block.<span class="literal">nil</span>?</div><div class="line">    @definition.declare_attribute(Declaration::Implicit.new(name, @definition, @ignore))</div><div class="line">  <span class="keyword">elsif</span> args.first.respond_to?(<span class="symbol">:has_key?</span>) &amp;&amp; args.first.has_key?(<span class="symbol">:factory</span>)</div><div class="line">    association(name, *args)</div><div class="line">  <span class="keyword">else</span></div><div class="line">    add_attribute(name, *args, &amp;block)</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>由于赋值除了固定值，还可能是 block 或者 association，这里对几种情况分别进行了处理。</p><p>FactoryGirl.define 的分析差不多结束了，method_missing 这一元编程的魔法在这里又发挥了巨大的作用。</p><h3 id="FactoryGirl-create"><a href="#FactoryGirl-create" class="headerlink" title="FactoryGirl.create"></a>FactoryGirl.create</h3><p>讲完了 Factory 是如何定义的，我们来研究下如何创建一个 Factory。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">user = FactoryGirl.create(<span class="symbol">:user</span>, <span class="symbol">name:</span> <span class="string">'Link'</span>)</div></pre></td></tr></table></figure></p><p>我们首先得找到 create 的入口。当搜寻了一遍之后会发现，并没有显式定义 create 的地方。看来该方法是动态定义的了。从官方文档上来看，create 定义在 FactoryGirl::Syntax::Methods。搜索之后发现 StrategySyntaxMethodRegistrar 里出现了给它动态添加方法的代码。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># strategy_syntax_method_registrar.rb</span></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">FactoryGirl</span></span></div><div class="line">    private</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">define_singular_strategy_method</span></span></div><div class="line">      strategy_name = @strategy_name</div><div class="line"></div><div class="line">      define_syntax_method(strategy_name) <span class="keyword">do</span> <span class="params">|name, *traits_and_overrides, &amp;block|</span></div><div class="line">        FactoryRunner.new(name, strategy_name, traits_and_overrides).run(&amp;block)</div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">define_syntax_method</span><span class="params">(name, &amp;block)</span></span></div><div class="line">      FactoryGirl::Syntax::Methods.module_exec <span class="keyword">do</span></div><div class="line">        <span class="keyword">if</span> method_defined?(name) <span class="params">||</span> private_method_defined?(name)</div><div class="line">          undef_method(name)</div><div class="line">        <span class="keyword">end</span></div><div class="line"></div><div class="line">        define_method(name, &amp;block)</div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>用 create 替换 strategy_name，FactoryGirl.create 实质调用了 <code>FactoryRunner.new(name, :create, : traits_and_overrides).run(&amp;block)</code>。而 FactoryRunner#run 在进行了一些准备后，最终调用了 <code>factory.run(runner_strategy, @overrides, &amp;block)</code> 来创建对象。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Factory#run</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(build_strategy, overrides, &amp;block)</span></span></div><div class="line">  block <span class="params">||</span>= -&gt;(result) &#123; result &#125;</div><div class="line">  compile</div><div class="line">  strategy = StrategyCalculator.new(build_strategy).strategy.new</div><div class="line">  evaluator = evaluator_class.new(strategy, overrides.symbolize_keys)</div><div class="line">  attribute_assigner = AttributeAssigner.new(evaluator, build_class, &amp;compiled_constructor)</div><div class="line">  evaluation = Evaluation.new(attribute_assigner, compiled_to_create)</div><div class="line">  evaluation.add_observer(CallbacksObserver.new(callbacks, evaluator))</div><div class="line">  strategy.result(evaluation).tap(&amp;block)</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure><p>最后一行 <code>strategy.result(evaluation).tap(&amp;block)</code> 最终返回的是 evaluation.object，而 evaluation 把 object 委托给 attribute_assigner。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># AttributeAssigner#object</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">object</span></span></div><div class="line">  @evaluator.instance = build_class_instance</div><div class="line">  build_class_instance.tap <span class="keyword">do</span> <span class="params">|instance|</span></div><div class="line">    attributes_to_set_on_instance.each <span class="keyword">do</span> <span class="params">|attribute|</span></div><div class="line">      instance.public_send(<span class="string">"<span class="subst">#&#123;attribute&#125;</span>="</span>, get(attribute))</div><div class="line">      @attribute_names_assigned &lt;&lt; attribute</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>build_class_instance 实质上调用了 User.new 方法，创建了 User 对象。<code>instance.public_send</code> 对该对象的属性进行赋值。</p><p>至此最关键的创建步骤说完了，我们简单地说下其他几行的作用。<br><code>compile</code> 主要处理 Factory 之间的继承关系。<br><code>StrategyCalculator.new(build_strategy).strategy.new</code> 为简单工厂，可以根据 Strategy 的名字找到对应的类。<br>evaluator 保存了属性的赋值。为什么不直接进行赋值，而要使用一个中间类？我觉得原因是，FactoryGirl 创建 user 时不仅可以给 user 的属性赋值，还可以给 evaluator 赋值。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">factory <span class="symbol">:user</span> <span class="keyword">do</span></div><div class="line">    name <span class="string">"John Doe"</span></div><div class="line">    factory <span class="symbol">:user_with_posts</span> <span class="keyword">do</span></div><div class="line">      transient <span class="keyword">do</span></div><div class="line">        posts_count <span class="number">5</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">      after(<span class="symbol">:create</span>) <span class="keyword">do</span> <span class="params">|user, evaluator|</span></div><div class="line">        create_list(<span class="symbol">:post</span>, evaluator.posts_count, <span class="symbol">user:</span> user)</div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment"># 调用</span></div><div class="line">create(<span class="symbol">:user_with_posts</span>, <span class="symbol">posts_count:</span> <span class="number">15</span>)</div></pre></td></tr></table></figure></p><p>这里的 posts_count 不是 user 本身的属性，而属于 evaluator。<br>AttributeAssigner 创建了 user 对象，并给它赋值。<br>Evaluation 是对 Strategy 回调方法的一个封装，比如 Strategy::Create，都是直接调用的 evaluation 的方法。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Strategy::Create#result</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">result</span><span class="params">(evaluation)</span></span></div><div class="line">  evaluation.object.tap <span class="keyword">do</span> <span class="params">|instance|</span></div><div class="line">    evaluation.notify(<span class="symbol">:after_build</span>, instance)</div><div class="line">    evaluation.notify(<span class="symbol">:before_create</span>, instance)</div><div class="line">    evaluation.create(instance)</div><div class="line">    evaluation.notify(<span class="symbol">:after_create</span>, instance)</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>顺带说下，compiled_constructor、compiled_to_create 在经过千辛万苦的查找后，是两个非常简单的 block。compiled_constructor 为 <code>{ new }</code>，而 compiled_to_create 为 <code>{ |instance| instance.save! }</code>，来自 configuration.rb 19、20 行。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>由于水平精力有限，只简单地分析了最基础的 define 和 create 方法。<br>define 使用了 method_missing 来实现属性的赋值。由于 FactoryGirl create 对象时能通过很灵活的方式，比如 trait，使得其代码在创建对象时要考虑各方面的配置。这里只抽出了最主要的流程进行说明。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;FactoryGirl 是我个人十分喜欢的 Gem，它能很方便地模拟测试数据。使用技巧可见 &lt;a href=&quot;http://www.jianshu.com/p/cca80f341d77&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;FactoryGirl 技巧&lt;/a&gt;。出于兴趣我研究了下它的源代码，说实话比想象得要复杂。由于 FactoryGirl 配置的灵活性以及 Ruby 本身的语言特点，使得它代码整体上比较飘逸。&lt;br&gt;这里我会对它最基础的方法进行分析，版本为 4.8.0。&lt;/p&gt;
&lt;h3 id=&quot;FactoryGirl-define&quot;&gt;&lt;a href=&quot;#FactoryGirl-define&quot; class=&quot;headerlink&quot; title=&quot;FactoryGirl.define&quot;&gt;&lt;/a&gt;FactoryGirl.define&lt;/h3&gt;&lt;p&gt;先从定义 Factory 开始。下面的代码定义了名为 user 的 Factory，它有一个名为 name 的属性，值为 Kay。&lt;br&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;FactoryGirl.define &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  factory &lt;span class=&quot;symbol&quot;&gt;:user&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    name &lt;span class=&quot;string&quot;&gt;&#39;Kay&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Ruby" scheme="http://kaywu.xyz/categories/Ruby/"/>
    
    
      <category term="Ruby" scheme="http://kaywu.xyz/tags/Ruby/"/>
    
  </entry>
  
  <entry>
    <title>正则表达式必知必会</title>
    <link href="http://kaywu.xyz/2017/05/30/regex/"/>
    <id>http://kaywu.xyz/2017/05/30/regex/</id>
    <published>2017-05-30T09:37:21.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="匹配单个字符"><a href="#匹配单个字符" class="headerlink" title="匹配单个字符"></a>匹配单个字符</h2><h3 id="匹配纯文本"><a href="#匹配纯文本" class="headerlink" title="匹配纯文本"></a>匹配纯文本</h3><p>正则：<code>Ben</code><br>&gt;<br>Hello, my name is <code>Ben</code>. Please visit my website at <a href="http://www.forta.com/" target="_blank" rel="external">http://www.forta.com/</a>.</p><h3 id="匹配任意字符"><a href="#匹配任意字符" class="headerlink" title="匹配任意字符"></a>匹配任意字符</h3><p>. 匹配任意单个字符。在绝大多数的正则表达式实现里，. 只能匹配除换行符以外的任何单个字符。<br>正则：<code>sales.</code><br>&gt;<br><code>sales1</code>.xls<br>orders3.xls<br><code>sales2</code>.xls<br><code>sales3</code>.xls<br>apac1.xls<br>europe2.xls<br>na1.xls<br>na2.xls<br>sa1.xls</p><a id="more"></a><h3 id="匹配特殊字符"><a href="#匹配特殊字符" class="headerlink" title="匹配特殊字符"></a>匹配特殊字符</h3><p>元字符是一些在正则表达式里有着特殊含义的字符。如英语句号（.）是一个元字符，它可以用来匹配任何一个单个字符。因为元字符在正则表达式里有着特殊的含义，所以这些字符就无法用来代表它们本身。比如你不能使用 . 类匹配 . 本身。<br>在元字符的前面加上一个反斜杠就可以对它进行转移，转义序列 . 将匹配 . 本身。<br>正则：<code>.a.\.xls</code></p><p>&gt;<br>sales1.xls<br>orders3.xls<br>sales2.xls<br>sales3.xls<br>apac1.xls<br>europe2.xls<br><code>na1.xls</code><br><code>na2.xls</code><br><code>sa1.xls</code></p><h2 id="匹配一组字符"><a href="#匹配一组字符" class="headerlink" title="匹配一组字符"></a>匹配一组字符</h2><h3 id="匹配多个字符中的某一个"><a href="#匹配多个字符中的某一个" class="headerlink" title="匹配多个字符中的某一个"></a>匹配多个字符中的某一个</h3><p>可以使用元字符 [  和 ] 来定义一个字符集合，在使用 [ 和 ] 定义的字符集合里，这两个元字符之间的所有字符都是该集合的组成部分，字符集合的匹配结果是能够与该集合里的任意一个成员想匹配的文本。<br>正则：<code>[ns]a.\.xls</code><br>&gt;<br>sales1.xls<br>orders3.xls<br>sales2.xls<br>sales3.xls<br>apac1.xls<br>europe2.xls<br><code>na1.xls</code><br><code>na2.xls</code><br><code>sa1.xls</code><br>ca1.xls</p><h3 id="利用字符集合区间"><a href="#利用字符集合区间" class="headerlink" title="利用字符集合区间"></a>利用字符集合区间</h3><p>模式 [0-9] 的功能与 [0123456789] 完全等价。</p><p>正则：<code>[ns]a[0-9]\.xls</code><br>&gt;<br>sales1.xls<br>orders3.xls<br>sales2.xls<br>sales3.xls<br>apac1.xls<br>europe2.xls<br><code>na1.xls</code><br><code>na2.xls</code><br><code>sa1.xls</code><br>ca1.xls</p><p>其他常用的字符区间：<br>A-Z：匹配从 A 到 Z 的所有大写字母。<br>a-z：匹配从 a 到 z 的所有小写字母。</p><h3 id="取非匹配"><a href="#取非匹配" class="headerlink" title="取非匹配"></a>取非匹配</h3><p>用元字符 ^ 来表明你相对一个字符集合进行取非匹配，也就是除了那个字符集里的字符，其他字符都可以匹配。<br>正则：<code>[ns]a[^0-9]\.xls</code><br>&gt;<br>sales1.xls<br>orders3.xls<br>sales2.xls<br>sales3.xls<br>apac1.xls<br>europe2.xls<br><code>sam.xls</code><br>na1.xls<br>na2.xls<br>sa1.xls<br>ca1.xls</p><h3 id="匹配特定的字符类型"><a href="#匹配特定的字符类型" class="headerlink" title="匹配特定的字符类型"></a>匹配特定的字符类型</h3><table><thead><tr><th>元字符</th><th>说明</th></tr></thead><tbody><tr><td>\d</td><td>任何一个数字字符（等价于[0-9]）</td></tr><tr><td>\D</td><td>任何一个非数字字符（等价于[^0-9]）</td></tr><tr><td>\w</td><td>任何一个字母数字字符（大小写均可）或下划线字符（等价于[a-zA-Z0-9_]）</td></tr><tr><td>\W</td><td>任何一个非字母数字或非下划线字符（等价于[^a-zA-Z0-9_]）</td></tr></tbody></table><p>正则：<code>myArray\[\d\]</code><br>&gt;<br>var myArray = new Array();<br>…<br>if (<code>myArray[0]</code> == 0) {<br>…<br>}</p><p>正则：<code>\w\d\w\d\w\d</code><br>&gt;<br>11213<br><code>A1C2E3</code><br>48075<br>48237<br><code>M1B4F2</code><br>90046<br><code>H1H2H2</code></p><h3 id="匹配空白字符"><a href="#匹配空白字符" class="headerlink" title="匹配空白字符"></a>匹配空白字符</h3><table><thead><tr><th>元字符</th><th>说明</th></tr></thead><tbody><tr><td>[\b]</td><td>回退（并删除）一个字符（Backspace键）</td></tr><tr><td>\f</td><td>换页符</td></tr><tr><td>\n</td><td>换行符</td></tr><tr><td>\r</td><td>回车符</td></tr><tr><td>\t</td><td>制表符</td></tr><tr><td>\v</td><td>垂直制表符</td></tr><tr><td>\s</td><td>任何一个空白字符（等价于[\f\n\r\t\v]）</td></tr><tr><td>\S</td><td>任何一个非空白字符（等价于[^\f\n\r\t\v]）</td></tr></tbody></table><h2 id="重复匹配"><a href="#重复匹配" class="headerlink" title="重复匹配"></a>重复匹配</h2><h3 id="匹配一个或多个字符"><a href="#匹配一个或多个字符" class="headerlink" title="匹配一个或多个字符"></a>匹配一个或多个字符</h3><ul><li>匹配一个或多个字符（至少一个；不匹配零个字符的情况）。<br>正则：<code>\w+@\w+\.\w+</code><br>&gt;<br>Send personal email to <code>ben@forta.com</code>. For questions about a book use <code>support@forta.com</code>. Feel free to send unsolicited email to <code>spam@forta.com</code> (wouldn’t it be nice if it were that simple, huh?).</li></ul><h3 id="匹配零个或多个字符"><a href="#匹配零个或多个字符" class="headerlink" title="匹配零个或多个字符"></a>匹配零个或多个字符</h3><ul><li>元字符匹配零个或多个字符。<br>正则：<code>\w+[\w.]*@[\w.]+\.\w+</code><br>&gt;<br>Hello, <code>.ben@forta.com</code> is my email address.</li></ul><h3 id="匹配零个或一个字符"><a href="#匹配零个或一个字符" class="headerlink" title="匹配零个或一个字符"></a>匹配零个或一个字符</h3><p>? 只能匹配一个字符（或字符集合）的零次或一次出现，最多不超过一次。<br>正则：<code>https?://[\w./]+</code><br>&gt;<br>The URL is <code>http://www.forta.com/</code>, to connect securely use <code>https://www.forta.com/</code> instead.</p><h3 id="匹配的重复次数"><a href="#匹配的重复次数" class="headerlink" title="匹配的重复次数"></a>匹配的重复次数</h3><p>{3}意味着模式里的前一个字符（或字符集合）必须在原始文本里连续重复出现 3 次才算是一个匹配。<br>{2, 4} 的含义是最少重复 2 次、最多重复 4 次。<br>{3，} 表示至少重复 3 次。</p><h3 id="懒惰型元字符"><a href="#懒惰型元字符" class="headerlink" title="懒惰型元字符"></a>懒惰型元字符</h3><p>正则：<code>&lt;[Bb]&gt;.*&lt;/[Bb]&gt;</code><br>&gt;<br>This offer is not available to customers living in <code>&lt;B&gt;AK&lt;/B&gt; and &lt;B&gt;HI&lt;/B&gt;</code>.</p><p>因为 * 和 + 都是所谓的“贪婪型”元字符，它们在进行匹配时的行为模式是多多益善而不是适可而止的，会尽可能地从一段文本的开头一直匹配到这段文本的末尾。<br>在不需要这种“贪婪行为”的时候该怎么办？答案是使用这些元字符的“懒惰型”版本。懒惰型元字符只要给贪婪性元字符加上一个 ? 后缀即可。</p><table><thead><tr><th>贪婪型元字符</th><th>懒惰型元字符</th></tr></thead><tbody><tr><td>*</td><td>*?</td></tr><tr><td>+</td><td>+?</td></tr><tr><td>{n, }</td><td>{n, }?</td></tr></tbody></table><p>正则：<code>&lt;[Bb]&gt;.*?&lt;/[Bb]&gt;</code><br>&gt;<br>This offer is not available to customers living in <code>&lt;B&gt;AK&lt;/B&gt;</code> and <code>&lt;B&gt;HI&lt;/B&gt;</code>.</p><h2 id="位置匹配"><a href="#位置匹配" class="headerlink" title="位置匹配"></a>位置匹配</h2><h3 id="单词边界"><a href="#单词边界" class="headerlink" title="单词边界"></a>单词边界</h3><p>\b 用来匹配一个单词的开始或结尾。<br>简单地说，\b 匹配的是一个这样的位置，这个位置位于一个能够用户构成单词的字符（字母、数字和下划线，也就是与 \w 相匹配的字符）和一个不能用来构成单词的字符（也就是与 \W 相匹配的字符）之间。<br>正则：<code>\bcat\b</code><br>&gt;<br>The <code>cat</code> scattered his food all over the room.</p><h3 id="字符串边界"><a href="#字符串边界" class="headerlink" title="字符串边界"></a>字符串边界</h3><p>^ 用来定义字符串开头，\$ 用来定义字符串结尾。<br>注意：不同语言对 ^ \$ 的处理有所不同。比如 Javascript 是按照以上定义实现的，而 Ruby 中 ^ 匹配一行的开始，\$ 匹配一行的结束。具体可参考 <a href="http://www.regular-expressions.info/anchors.html。" target="_blank" rel="external">http://www.regular-expressions.info/anchors.html。</a></p><h2 id="使用子表达式"><a href="#使用子表达式" class="headerlink" title="使用子表达式"></a>使用子表达式</h2><p>子表达式是一个更大的表达式的一部分，把一个表达式划分为一系列子表达式的目的是为了把那些子表达式当做一个独立元素来使用。子表达式必须用 ( 和 ) 括起来。<br>正则：<code>(19|20)\d{2}</code><br>&gt;<br>ID: 042<br>SEX: M<br>DOB: <code>1967</code>-08-17<br>Status: Active</p><p>| 字符表示或操作符，19|20 将匹配数字序列 19 或 20。</p><h2 id="回溯引用：前后一致匹配"><a href="#回溯引用：前后一致匹配" class="headerlink" title="回溯引用：前后一致匹配"></a>回溯引用：前后一致匹配</h2><p>正则：<code>[ ]+(\w+)[ ]+\1</code><br>&gt;<br>This is a block <code>of of</code> text, several words here <code>are are</code> repeated, <code>and and</code> they should not be.</p><p>\1 不是一个回溯引用，而它引用的正是前面划分出来的那个子表达式。当 (\w+) 匹配到单词 of 的时候，\1 也匹配单词 of；当 (\w+) 匹配到单词 and 的时候，\1 也匹配单词 and。<br>为了方便理解，可以把回溯引用想象成变量。</p><h2 id="前后查找"><a href="#前后查找" class="headerlink" title="前后查找"></a>前后查找</h2><p>前后查找包含的匹配本身并不返回，而是用于确定正确的匹配位置，它并不是匹配结果的一部分。</p><h3 id="向前查找"><a href="#向前查找" class="headerlink" title="向前查找"></a>向前查找</h3><p>从语法上看，一个向前查找模式其实就是一个以 ?= 开头的子表达式，需要匹配的文本跟在 = 后面。</p><p>正则：<code>.+(?=:)</code><br>&gt;<br><code>http</code>://www.forta.com/<br><code>https</code>://mail.forta.com/<br><code>ftp</code>://ftp.forta.com/</p><p>与子表达的对比。<br>正则：<code>.+(:)</code><br>&gt;<br><code>http:</code>//www.forta.com/<br><code>https:</code>//mail.forta.com/<br><code>ftp:</code>//ftp.forta.com/</p><h3 id="向后查找"><a href="#向后查找" class="headerlink" title="向后查找"></a>向后查找</h3><p>向后查找，以 ?&lt;= 开头的子表达式。<br>正则： <code>(?=\$)[0-9.]+</code><br>&gt;<br>ABC01: $<code>23.45</code><br>Total items found: 4</p><h3 id="对前后查找取非"><a href="#对前后查找取非" class="headerlink" title="对前后查找取非"></a>对前后查找取非</h3><p>负向前查找讲向前查找不与给定模式相匹配的文本，负向后查找将向后查找不与给定模式相匹配的文本。</p><table><thead><tr><th>操作符</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>(?=)</td><td>正向前查找</td><td>\d+(?= dollars) matches 100 in “100 dollars”</td></tr><tr><td>(?!)</td><td>负向前查找</td><td>d+(?! dollars) matches 100 if it is NOT followed by the word “dollars”</td></tr><tr><td>(?&lt;=)</td><td>正向后查找</td><td>(?&lt;=lucky )\d matches 7 in “lucky 7”</td></tr><tr><td>(?&lt;!)</td><td>负向后查找</td><td>(?&lt;!furious )\d matches 7 in “lucky 7”</td></tr></tbody></table><h2 id="嵌入条件"><a href="#嵌入条件" class="headerlink" title="嵌入条件"></a>嵌入条件</h2><p>(?(backreference)true-regex)：? 表示这是一个条件，括号里的 backreference 是一个回溯引用， backreference 存在时会执行true-regex。<br>(?(backreference)true-regex|false-regex)： backreference 不存在时会执行 false-regex。</p><h3 id="回溯引用条件"><a href="#回溯引用条件" class="headerlink" title="回溯引用条件"></a>回溯引用条件</h3><p>正则：<code>(\()?\d{3}(?(1)\)|-)\d{3}-\d{4}</code><br>&gt;<br><code>123-456-7890</code><br><code>(123)456-7890</code><br>(123)-456-7890<br>(123-456-7890<br>1234567890<br>123 456 7890</p><p>(()? 匹配一个可选的左括号,(?(1))|-) 将根据条件是否满足而去匹配 ) 或者 -。如果 (1) 存在，) 必须被匹配，否则 - 必须被匹配。</p><h3 id="前后查找条件"><a href="#前后查找条件" class="headerlink" title="前后查找条件"></a>前后查找条件</h3><p>前后查找条件的语法与回溯引用条件的语法大同小异，只需把回溯引用替换为一个完整的前后查找表达式就行了。<br>正则：<code>\d{5}(?(?=-)-\d{4})</code><br>&gt;<br>11111<br>22222<br>33333-<br>44444-4444</p><p>(?(?=-)-\d{4}) 使用了 ?=- 来匹配（但不消费）一个连字符，如果条件得到满足（那个连字符存在），-\d{4} 将匹配那个连字符和随后的 4 位数字。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;匹配单个字符&quot;&gt;&lt;a href=&quot;#匹配单个字符&quot; class=&quot;headerlink&quot; title=&quot;匹配单个字符&quot;&gt;&lt;/a&gt;匹配单个字符&lt;/h2&gt;&lt;h3 id=&quot;匹配纯文本&quot;&gt;&lt;a href=&quot;#匹配纯文本&quot; class=&quot;headerlink&quot; title=&quot;匹配纯文本&quot;&gt;&lt;/a&gt;匹配纯文本&lt;/h3&gt;&lt;p&gt;正则：&lt;code&gt;Ben&lt;/code&gt;&lt;br&gt;&amp;gt;&lt;br&gt;Hello, my name is &lt;code&gt;Ben&lt;/code&gt;. Please visit my website at &lt;a href=&quot;http://www.forta.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.forta.com/&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;匹配任意字符&quot;&gt;&lt;a href=&quot;#匹配任意字符&quot; class=&quot;headerlink&quot; title=&quot;匹配任意字符&quot;&gt;&lt;/a&gt;匹配任意字符&lt;/h3&gt;&lt;p&gt;. 匹配任意单个字符。在绝大多数的正则表达式实现里，. 只能匹配除换行符以外的任何单个字符。&lt;br&gt;正则：&lt;code&gt;sales.&lt;/code&gt;&lt;br&gt;&amp;gt;&lt;br&gt;&lt;code&gt;sales1&lt;/code&gt;.xls&lt;br&gt;orders3.xls&lt;br&gt;&lt;code&gt;sales2&lt;/code&gt;.xls&lt;br&gt;&lt;code&gt;sales3&lt;/code&gt;.xls&lt;br&gt;apac1.xls&lt;br&gt;europe2.xls&lt;br&gt;na1.xls&lt;br&gt;na2.xls&lt;br&gt;sa1.xls&lt;/p&gt;
    
    </summary>
    
      <category term="读书笔记" scheme="http://kaywu.xyz/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="读书笔记" scheme="http://kaywu.xyz/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>Rails 多台服务器上 js 不一致的问题</title>
    <link href="http://kaywu.xyz/2017/05/14/rails-js-compress/"/>
    <id>http://kaywu.xyz/2017/05/14/rails-js-compress/</id>
    <published>2017-05-14T10:00:27.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="发现问题"><a href="#发现问题" class="headerlink" title="发现问题"></a>发现问题</h3><p>周二发布正式的时候，发生了匪夷所思的事情。<br>打开发布的网页，有一定的几率操作会没有反应。但在测试的时候却从没有这个问题发生。通过调试工具查看网页，发现一半的网页会加载 application-b1a 开头的文件，而另一半会加载 application-745 开头的文件。加载 applicaton-745 时会报 404，使得操作没有反应。</p><p>这里简单地说下发布的情况。该服务会发布到 A、B 两台服务器上，nginx 接收请求并转发到 A、B 上的实例。<br>查看正式服务器上的文件发现，A 上存在 application-b1a 文件，B 上存在 application-745 文件。看来 nginx 会查找 服务器 A 上的文件，由于找不到 application-745 而返回 404。先把 B 上的 applicaiton-b1a 复制到 A，临时修复这个问题。</p><h3 id="排查原因"><a href="#排查原因" class="headerlink" title="排查原因"></a>排查原因</h3><p>为什么两个服务器上生成的 js 文件名会不一致？我们先简单地回顾下 Asset Pipeline 生成 js 的过程。正式环境上， Asset Pipeline 会预编译文件，生成类似于 <code>application-908e25f4bf641868d8683022a5b62f54.js</code> 的文件。其中 908e 这串表示摘要，是根据文件的内容生成的 MD5，当 js 文件发生改变时生成的摘要也会发生变化。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/<span class="regexp">/ 引用 js</span></div><div class="line"><span class="regexp">&lt;%= javascript_include_tag "application" %&gt;</span></div><div class="line"><span class="regexp"></span></div><div class="line"><span class="regexp">/</span><span class="regexp">/ 生成的 html</span></div><div class="line"><span class="regexp">&lt;script src="/assets</span><span class="regexp">/application-908e25f4bf641868d8683022a5b62f54.js"&gt;&lt;/script</span>&gt;</div></pre></td></tr></table></figure></p><a id="more"></a><p>换句话说，若 js 内容一样，生成的摘要也应该是一样的。不应该啊！两个服务器部署的代码应该是一致的。为了保险起见，我还特定查看了相关文件的 MD5 值，完全相同。</p><p>输入是相同的，而产生的结果却不一样，问题应该出在处理步骤上。于是我查看了正式环境的配置，发现了以下这条。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">config.assets.js_compressor = <span class="symbol">:uglifier</span></div></pre></td></tr></table></figure></p><p>uglifier 是用 ruby 封装 UglifyJS 的 gem，而 UglifyJS 是依赖 node.js 对 js 进行压缩的。查看了下两台服务器的 node 版本，A 是 0.10，B 是 6.10。问题的原因终于找到了。node 的版本不一致，导致其压缩的结果不一样，使得生成的最终文件也不相同。</p><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>先在 A 上升级了 node 版本，使得 A、B 两台服务器的 node 版本一致。然后删除 <code>tmp/cache/assets/sprockets</code> 下的缓存，再执行 <code>RAILS_ENV=production bin/rake assets:precompile</code>，最后重新发布，使最新生成的结果能被实例加载。<br>注意这里必须先删除缓存，不然执行 precompile 时不会生成最新的结果。</p><h3 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h3><p>为什么这个问题会突然出现呢？原来是 B 上的 node 版本由于其他应用的需求进行了升级，使得 A、B 两台版本不一致了。<br>这种一个馒头引发的血案防不胜防，可见应用之间依赖的隔离是多么重要。联想到近几年类似 docker 的解决方案大受欢迎也就不足为怪了。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://guides.rubyonrails.org/asset_pipeline.html" target="_blank" rel="external">Asset Pipeline</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;发现问题&quot;&gt;&lt;a href=&quot;#发现问题&quot; class=&quot;headerlink&quot; title=&quot;发现问题&quot;&gt;&lt;/a&gt;发现问题&lt;/h3&gt;&lt;p&gt;周二发布正式的时候，发生了匪夷所思的事情。&lt;br&gt;打开发布的网页，有一定的几率操作会没有反应。但在测试的时候却从没有这个问题发生。通过调试工具查看网页，发现一半的网页会加载 application-b1a 开头的文件，而另一半会加载 application-745 开头的文件。加载 applicaton-745 时会报 404，使得操作没有反应。&lt;/p&gt;
&lt;p&gt;这里简单地说下发布的情况。该服务会发布到 A、B 两台服务器上，nginx 接收请求并转发到 A、B 上的实例。&lt;br&gt;查看正式服务器上的文件发现，A 上存在 application-b1a 文件，B 上存在 application-745 文件。看来 nginx 会查找 服务器 A 上的文件，由于找不到 application-745 而返回 404。先把 B 上的 applicaiton-b1a 复制到 A，临时修复这个问题。&lt;/p&gt;
&lt;h3 id=&quot;排查原因&quot;&gt;&lt;a href=&quot;#排查原因&quot; class=&quot;headerlink&quot; title=&quot;排查原因&quot;&gt;&lt;/a&gt;排查原因&lt;/h3&gt;&lt;p&gt;为什么两个服务器上生成的 js 文件名会不一致？我们先简单地回顾下 Asset Pipeline 生成 js 的过程。正式环境上， Asset Pipeline 会预编译文件，生成类似于 &lt;code&gt;application-908e25f4bf641868d8683022a5b62f54.js&lt;/code&gt; 的文件。其中 908e 这串表示摘要，是根据文件的内容生成的 MD5，当 js 文件发生改变时生成的摘要也会发生变化。&lt;br&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;/&lt;span class=&quot;regexp&quot;&gt;/ 引用 js&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;&amp;lt;%= javascript_include_tag &quot;application&quot; %&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;regexp&quot;&gt;/ 生成的 html&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;&amp;lt;script src=&quot;/assets&lt;/span&gt;&lt;span class=&quot;regexp&quot;&gt;/application-908e25f4bf641868d8683022a5b62f54.js&quot;&amp;gt;&amp;lt;/script&lt;/span&gt;&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Rails" scheme="http://kaywu.xyz/categories/Rails/"/>
    
    
      <category term="Rails" scheme="http://kaywu.xyz/tags/Rails/"/>
    
  </entry>
  
  <entry>
    <title>Rails 如何在开发模式下重新加载源代码</title>
    <link href="http://kaywu.xyz/2017/05/01/rails-dev-reload/"/>
    <id>http://kaywu.xyz/2017/05/01/rails-dev-reload/</id>
    <published>2017-05-01T10:04:50.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>在 Rails development 环境下，若更改了部分代码，只需要重新发起请求，就能看到最新代码的结果，不需要重启服务器。<br>下文简述 Rails 是如何做到这点的。</p><p>在 <code>config/development.rb</code>，也就是 development 的环境配置文件，我们可以看到不同于其他环境的一行：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># In the development environment your application's code is reloaded on</span></div><div class="line"><span class="comment"># every request.  This slows down response time but is perfect for development</span></div><div class="line"><span class="comment"># since you don't have to restart the webserver when you make code changes.</span></div><div class="line">config.cache_classes = <span class="literal">false</span></div></pre></td></tr></table></figure></p><p>正如注释所说的，它会使得 Rails 在每次接收请求时都重新加载源代码。</p><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>我们先从 Rails 的初始化说起，以 Rails 4.2.6 为例。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rails/application/default_middleware_stack.rb</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_stack</span></span></div><div class="line">    ...</div><div class="line">    <span class="keyword">unless</span> config.cache_classes</div><div class="line">        middleware.use <span class="symbol">:</span><span class="symbol">:ActionDispatch</span><span class="symbol">:</span><span class="symbol">:Reloader</span>, lambda &#123; reload_dependencies? &#125;</div><div class="line">    <span class="keyword">end</span></div><div class="line">    ...</div><div class="line">    private</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reload_dependencies?</span></span></div><div class="line">      config.reload_classes_only_on_change != <span class="literal">true</span> <span class="params">||</span> app.reloaders.map(&amp;<span class="symbol">:updated?</span>).any?</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>当 config.cache_classses 为 true 时，middleware 会增加 <code>ActionDispatch::Reloader</code>，而这正是重新加载源代码的关键。<br>ps： middleware 可以通过 <code>rake middleware</code> 来查看。</p><h3 id="处理请求"><a href="#处理请求" class="headerlink" title="处理请求"></a>处理请求</h3><p>当服务器接收到请求时，中间件 <code>ActionDispatch::Reloader</code> 使用回调 prepare、cleanup 来实现重载源代码。其中 prepare 在处理请求前被调用，cleanup 在处理请求后被调用。</p><a id="more"></a><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActionDispatch::Reloader</span></span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(app, condition=<span class="literal">nil</span>)</span></span></div><div class="line">    @app = app</div><div class="line">    @condition = condition <span class="params">||</span> lambda &#123; <span class="literal">true</span> &#125;</div><div class="line">    @validated = <span class="literal">true</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(env)</span></span></div><div class="line">    @validated = @condition.call</div><div class="line">    prepare!</div><div class="line"></div><div class="line">    response = @app.call(env)</div><div class="line">    response[<span class="number">2</span>] = <span class="symbol">:</span><span class="symbol">:Rack</span><span class="symbol">:</span><span class="symbol">:BodyProxy</span>.new(response[<span class="number">2</span>]) &#123; cleanup! &#125;</div><div class="line"></div><div class="line">    response</div><div class="line">  <span class="keyword">rescue</span> Exception</div><div class="line">    cleanup!</div><div class="line">    raise</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">prepare!</span> <span class="comment">#:nodoc:</span></span></div><div class="line">    run_callbacks <span class="symbol">:prepare</span> <span class="keyword">if</span> validated?</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">cleanup!</span> <span class="comment">#:nodoc:</span></span></div><div class="line">    run_callbacks <span class="symbol">:cleanup</span> <span class="keyword">if</span> validated?</div><div class="line">  <span class="keyword">ensure</span></div><div class="line">    @validated = <span class="literal">true</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  private</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">validated?</span></span></div><div class="line">    @validated</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure><p>当 @validated 为 true 时会执行 prepare、cleanup 等回调。那么 @validated 的值是怎么得到的？<br>结合初始化的代码我们发现，@condition 其实就是创建 <code>ActionDispatch::Reloader</code> 时的参数 <code>lambda { reload_dependencies? }</code>。而 reload_dependencies? 具体代码如下。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">reload_dependencies?</span></span></div><div class="line">      config.reload_classes_only_on_change != <span class="literal">true</span> <span class="params">||</span> app.reloaders.map(&amp;<span class="symbol">:updated?</span>).any?</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>可以通过以下几种情况来分析<br>若 config.reload_clases_only_on_change 为 false，会执行回调。<br>若 config.reload_clases_only_on_change 为 true 且代码发生了变动（任一 reloader 调用 updated? 返回 true），会执行回调。<br>若 config.reload_clases_only_on_change 为 true 且代码未发生变动，不会执行回调。</p><h3 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h3><p>弄清楚了回调调用的时机，我们来继续研究回调的内容是什么。</p><p><code>Rails::Application::Finisher</code> 负责结束 Rails 的初始化，它会给 <code>ActionDispatch::Reloader</code> 增加回调。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rails/application/finisher.rb</span></div><div class="line">initializer <span class="symbol">:set_clear_dependencies_hook</span>, <span class="symbol">group:</span> <span class="symbol">:all</span> <span class="keyword">do</span></div><div class="line">  callback = lambda <span class="keyword">do</span></div><div class="line">    ActiveSupport::DescendantsTracker.clear</div><div class="line">    ActiveSupport::Dependencies.clear</div><div class="line">  <span class="keyword">end</span></div><div class="line">  <span class="keyword">if</span> config.reload_classes_only_on_change</div><div class="line">    reloader = config.file_watcher.new(*watchable_args, &amp;callback)</div><div class="line">    <span class="keyword">self</span>.reloaders &lt;&lt; reloader</div><div class="line">    <span class="comment"># Prepend this callback to have autoloaded constants cleared before</span></div><div class="line">    <span class="comment"># any other possible reloading, in case they need to autoload fresh</span></div><div class="line">    <span class="comment"># constants.</span></div><div class="line">    ActionDispatch::Reloader.to_prepare(<span class="symbol">prepend:</span> <span class="literal">true</span>) <span class="keyword">do</span></div><div class="line">      <span class="comment"># In addition to changes detected by the file watcher, if routes</span></div><div class="line">      <span class="comment"># or i18n have been updated we also need to clear constants,</span></div><div class="line">      <span class="comment"># that's why we run #execute rather than #execute_if_updated, this</span></div><div class="line">      <span class="comment"># callback has to clear autoloaded constants after any update.</span></div><div class="line">      reloader.execute</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">else</span></div><div class="line">    ActionDispatch::Reloader.to_cleanup(&amp;callback)</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>当 config.reload_clases_only_on_change 为 true，会向 <code>ActionDispatch::Reloader</code> 的 prepare 添加回调，而 false 时会向 cleanup 添加回调。<br>该回调会清理所有的依赖，更确切地说，使用内置的 remove_const 清除所有加载的常量。<br>由于所有常量都被移除，<code>ActiveSupport::Dependencies</code> 使用 const_missing 并再次加载相关类，从而使得修改后的代码被加载。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>当 config.cache_class 为 false 时 middleware 会增加中间件 <code>ActionDispatch::Reloader</code>。</p><p>当 config.reload_clases_only_on_change 为 true 时，<code>Rails::Application::Finisher</code> 会在 <code>ActionDispatch::Reloader</code> 增加 <code>prepare</code> 的回调。<br>请求处理前 Reloader 会根据代码是否更新来执行 <code>prepare</code> 回调，执行回调后会清理所有的依赖，<code>ActiveSupport::Dependencies</code> 使用 const_missing 并再次加载相关类，从而使得修改后的代码被加载。</p><p>当 config.reload_clases_only_on_change 为 false 时， <code>Rails::Application::Finisher</code> 会在 <code>ActionDispatch::Reloader</code> 增加 <code>cleanup</code> 的回调。Reloader 会在每次请求处理后执行回调清理所有的依赖。其他步骤类似。</p><p>关于更详细的步骤说明可以参考 <a href="http://crypt.codemancers.com/posts/2013-10-03-rails-reloading-in-dev-mode/" target="_blank" rel="external">How rails reloads your source code in development mode?</a>，关于 Rails 的 autoload 机制可以参考 <a href="http://guides.rubyonrails.org/autoloading_and_reloading_constants.html" target="_blank" rel="external">Autoloading and Reloading Constants</a>。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://crypt.codemancers.com/posts/2013-10-03-rails-reloading-in-dev-mode/" target="_blank" rel="external">How rails reloads your source code in development mode?</a></li><li><a href="http://guides.rubyonrails.org/autoloading_and_reloading_constants.html" target="_blank" rel="external">Autoloading and Reloading Constants</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在 Rails development 环境下，若更改了部分代码，只需要重新发起请求，就能看到最新代码的结果，不需要重启服务器。&lt;br&gt;下文简述 Rails 是如何做到这点的。&lt;/p&gt;
&lt;p&gt;在 &lt;code&gt;config/development.rb&lt;/code&gt;，也就是 development 的环境配置文件，我们可以看到不同于其他环境的一行：&lt;br&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# In the development environment your application&#39;s code is reloaded on&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# every request.  This slows down response time but is perfect for development&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# since you don&#39;t have to restart the webserver when you make code changes.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;config.cache_classes = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;正如注释所说的，它会使得 Rails 在每次接收请求时都重新加载源代码。&lt;/p&gt;
&lt;h3 id=&quot;初始化&quot;&gt;&lt;a href=&quot;#初始化&quot; class=&quot;headerlink&quot; title=&quot;初始化&quot;&gt;&lt;/a&gt;初始化&lt;/h3&gt;&lt;p&gt;我们先从 Rails 的初始化说起，以 Rails 4.2.6 为例。&lt;br&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# rails/application/default_middleware_stack.rb&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;build_stack&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;unless&lt;/span&gt; config.cache_classes&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        middleware.use &lt;span class=&quot;symbol&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;symbol&quot;&gt;:ActionDispatch&lt;/span&gt;&lt;span class=&quot;symbol&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;symbol&quot;&gt;:Reloader&lt;/span&gt;, lambda &amp;#123; reload_dependencies? &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    private&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;reload_dependencies?&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      config.reload_classes_only_on_change != &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;||&lt;/span&gt; app.reloaders.map(&amp;amp;&lt;span class=&quot;symbol&quot;&gt;:updated?&lt;/span&gt;).any?&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;当 config.cache_classses 为 true 时，middleware 会增加 &lt;code&gt;ActionDispatch::Reloader&lt;/code&gt;，而这正是重新加载源代码的关键。&lt;br&gt;ps： middleware 可以通过 &lt;code&gt;rake middleware&lt;/code&gt; 来查看。&lt;/p&gt;
&lt;h3 id=&quot;处理请求&quot;&gt;&lt;a href=&quot;#处理请求&quot; class=&quot;headerlink&quot; title=&quot;处理请求&quot;&gt;&lt;/a&gt;处理请求&lt;/h3&gt;&lt;p&gt;当服务器接收到请求时，中间件 &lt;code&gt;ActionDispatch::Reloader&lt;/code&gt; 使用回调 prepare、cleanup 来实现重载源代码。其中 prepare 在处理请求前被调用，cleanup 在处理请求后被调用。&lt;/p&gt;
    
    </summary>
    
      <category term="Rails" scheme="http://kaywu.xyz/categories/Rails/"/>
    
    
      <category term="Rails" scheme="http://kaywu.xyz/tags/Rails/"/>
    
  </entry>
  
  <entry>
    <title>MySQL EXPLAIN 解读</title>
    <link href="http://kaywu.xyz/2017/03/26/mysql-explain/"/>
    <id>http://kaywu.xyz/2017/03/26/mysql-explain/</id>
    <published>2017-03-26T09:55:35.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>EXPLAIN 解释了 MySQL 是如何执行 SQL 语句的。使用的方法很简单，在 SQL 语句前加上 <code>EXPLAIN</code> 关键字就可以。<br>下面是一个简单的例子，测试数据在文章末尾。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 例 1</div><div class="line">mysql&gt; EXPLAIN SELECT name FROM users WHERE id = 1\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: users</div><div class="line">         type: const</div><div class="line">possible_keys: PRIMARY</div><div class="line">          key: PRIMARY</div><div class="line">      key_len: 4</div><div class="line">          ref: const</div><div class="line">         rows: 1</div><div class="line">        Extra: NULL</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure></p><p>EXPLAIN 列的解释：</p><ul><li>id：SELECT 标识符，下面具体分析</li><li>select_type: SELECT 类型，下面会具体分析</li><li>table: 查询所使用的表</li><li>type: JOIN 的类型，下面会具体分析</li><li>possible_keys: 可能使用的索引，但不一定会真正使用</li><li>key: 真正使用的索引</li><li>key_len: 所使用的索引长度</li><li>ref: 与索引比较的列</li><li>rows: 预估需要扫描的行数</li><li>Extra: 额外信息</li></ul><a id="more"></a><h3 id="id"><a href="#id" class="headerlink" title="id"></a>id</h3><p>个人理解表示了 SELECT 的执行顺序。id 大的优先执行，id 相同的从上往下执行。</p><h3 id="select-type"><a href="#select-type" class="headerlink" title="select_type"></a>select_type</h3><p>select_type 表示查询的类型，具体种类见官方图表。<br><img src="/img/select_type.png" alt="select_type.png-来自官方文档"><br>SIMPLE 是最常见的种类，表示它未使用 UNION 及子查询。例 1 的查询就属于 SIMPLE。</p><p>当使用了关键字 UNION，查询的类型就会发生变化。<br><img src="/img/select_union.png" alt="select_union.png-41.3kB"></p><p>在这个查询中，我们可以看到 3 种类型的查询。 PRIMARY 表示最外层的查询，也就是 UNION 之前的 <code>SELECT name FROM users WHERE id = 1</code>。UNION 之后的 <code>SELECT name FROM users WHERE id = 2</code> 归为 UNION 类型。最后 UNION RESULT 将两次查询的结果归总。</p><p>下面是其他查询类型的例子。</p><h4 id="PRIMARY-amp-SUBQUERY"><a href="#PRIMARY-amp-SUBQUERY" class="headerlink" title="PRIMARY &amp; SUBQUERY"></a>PRIMARY &amp; SUBQUERY</h4><p>PRIMARY 为最外层的查询，而 SUBQUERY 则指子查询。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EXPLAIN SELECT * FROM users WHERE id = (SELECT user_id FROM orders WHERE id = 3);</div></pre></td></tr></table></figure></p><h4 id="PRIMARY-amp-DEPENDENT-SUBQUERY"><a href="#PRIMARY-amp-DEPENDENT-SUBQUERY" class="headerlink" title="PRIMARY &amp; DEPENDENT SUBQUERY"></a>PRIMARY &amp; DEPENDENT SUBQUERY</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EXPLAIN SELECT * FROM users WHERE EXISTS (SELECT user_id FROM orders WHERE orders.id = 3 and orders.user_id = users.id);</div></pre></td></tr></table></figure><h4 id="MATERIALIZED"><a href="#MATERIALIZED" class="headerlink" title="MATERIALIZED"></a>MATERIALIZED</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EXPLAIN SELECT DISTINCT user_id FROM orders WHERE id IN (SELECT DISTINCT order_id FROM order_items WHERE product_name = &apos;p1&apos;);</div></pre></td></tr></table></figure><h4 id="DERIVED"><a href="#DERIVED" class="headerlink" title="DERIVED"></a>DERIVED</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EXPLAIN SELECT * FROM (SELECT * FROM orders WHERE id = 3) o;</div></pre></td></tr></table></figure><h3 id="type"><a href="#type" class="headerlink" title="type"></a>type</h3><p>type 表示 JOIN 的类型，是查询是否高效的重要依据。<br>效率从高到低排列为 system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; all。</p><ul><li>system: 表中只有一条数据，const 连接的特殊类型。</li><li><p>const: 主键或唯一索引的等值比较，由于表中至多有一条符合的数据，所以速度很快。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">mysql&gt; EXPLAIN SELECT * FROM users WHERE id = 2\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: users</div><div class="line">         type: const</div><div class="line">possible_keys: PRIMARY</div><div class="line">          key: PRIMARY</div><div class="line">      key_len: 4</div><div class="line">          ref: const</div><div class="line">         rows: 1</div><div class="line">        Extra: NULL</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure></li><li><p>eq_ref: 上表的每一个行至多会匹配到该表的一行，是除 system 和 const 之外最高效的 join type。当索引为 PRIMARY KEY 或 UNIQUE NOT NULL 且被全部使用时会用到。常见于索引列的等值比较。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">mysql&gt; EXPLAIN SELECT * FROM users, orders WHERE orders.user_id = users.id\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: orders</div><div class="line">         type: index</div><div class="line">possible_keys: index_orders_on_user_id_and_price</div><div class="line">          key: index_orders_on_user_id_and_price</div><div class="line">      key_len: 8</div><div class="line">          ref: NULL</div><div class="line">         rows: 4</div><div class="line">        Extra: Using index</div><div class="line">*************************** 2. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: users</div><div class="line">         type: eq_ref</div><div class="line">possible_keys: PRIMARY</div><div class="line">          key: PRIMARY</div><div class="line">      key_len: 4</div><div class="line">          ref: explain_test.orders.user_id</div><div class="line">         rows: 1</div><div class="line">        Extra: NULL</div><div class="line">2 rows in set (0.00 sec)</div></pre></td></tr></table></figure></li><li><p>ref: 如果 join 不能根据键值只匹配一行时则会使用该 join type。常见于不是 UNIQUE 或 PRIMARY KEY的索引等值比较，或者是最左前缀规则的索引查询。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">mysql&gt; EXPLAIN SELECT orders.id FROM orders JOIN users ON orders.user_id = users.id WHERE users.name = &apos;Amy&apos;\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: users</div><div class="line">         type: ref</div><div class="line">possible_keys: PRIMARY,index_users_on_names</div><div class="line">          key: index_users_on_names</div><div class="line">      key_len: 152</div><div class="line">          ref: const</div><div class="line">         rows: 1</div><div class="line">        Extra: Using where; Using index</div><div class="line">*************************** 2. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: orders</div><div class="line">         type: ref</div><div class="line">possible_keys: index_orders_on_user_id_and_price</div><div class="line">          key: index_orders_on_user_id_and_price</div><div class="line">      key_len: 4</div><div class="line">          ref: explain_test.users.id</div><div class="line">         rows: 1</div><div class="line">        Extra: Using index</div><div class="line">2 rows in set (0.00 sec)</div></pre></td></tr></table></figure></li><li><p>range: 使用索引进行范围查询，输出的 key 字段表示使用哪个索引，key_len 表示所使用索引中最长的索引长度。注意此类型下 ref 字段为 NULL。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">mysql&gt; EXPLAIN SELECT * FROM users WHERE users.id IN (2, 3)\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: users</div><div class="line">         type: range</div><div class="line">possible_keys: PRIMARY</div><div class="line">          key: PRIMARY</div><div class="line">      key_len: 4</div><div class="line">          ref: NULL</div><div class="line">         rows: 2</div><div class="line">        Extra: Using where</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure></li><li><p>index: 全索引扫描, index 类型仅仅扫描所有的索引, 而不扫描数据。一般两种情况会出现。<br>一种是出现在所要查询的数据直接在索引树中就可以获取, 此时 Extra 字段会显示 Using index。另一种是全表扫描时按索引的顺序查找数据，此时 Extra 字段不会显示 Using index。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">mysql&gt; EXPLAIN SELECT users.name FROM users\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: users</div><div class="line">         type: index</div><div class="line">possible_keys: NULL</div><div class="line">          key: index_users_on_names</div><div class="line">      key_len: 152</div><div class="line">          ref: NULL</div><div class="line">         rows: 10</div><div class="line">        Extra: Using index</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure></li><li><p>ALL: 全表扫描。</p></li></ul><h3 id="Extra"><a href="#Extra" class="headerlink" title="Extra"></a>Extra</h3><p>Extra 字段提供了关于查询的额外信息，种类很多，具体可以看<a href="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html#explain-extra-information" target="_blank" rel="external">官方文档</a>。<br>除了上文提到的 Using index，这里再额外说两种。<br>Using filesort 表示 MySQL 需要遍历所有符合条件的行然后按照排序的 key 来使得最终的查询结果是有序的。<br>Using temporary 表示 MySQL 需要创建一个临时表来存储结果，通常发生在查询包含不同列的 GROUP BY 和 ORDER BY 子句。<br>看到这两者时，可以考虑对查询进行优化。</p><h3 id="使用的测试数据"><a href="#使用的测试数据" class="headerlink" title="使用的测试数据"></a>使用的测试数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE `users` (</div><div class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</div><div class="line">  `name` varchar(50) NOT NULL,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  KEY `index_users_on_names` (`name`)</div><div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div><div class="line"></div><div class="line">INSERT INTO users(name) VALUES (&apos;Amy&apos;);</div><div class="line">INSERT INTO users(name) VALUES (&apos;Bob&apos;);</div><div class="line">INSERT INTO users(name) VALUES (&apos;Cindy&apos;);</div><div class="line">INSERT INTO users(name) VALUES (&apos;Duke&apos;);</div><div class="line">INSERT INTO users(name) VALUES (&apos;Kay&apos;);</div><div class="line">INSERT INTO users(name) VALUES (&apos;Lucy&apos;);</div><div class="line">INSERT INTO users(name) VALUES (&apos;Mike&apos;);</div><div class="line">INSERT INTO users(name) VALUES (&apos;Nancy&apos;);</div><div class="line">INSERT INTO users(name) VALUES (&apos;Ted&apos;);</div><div class="line">INSERT INTO users(name) VALUES (&apos;Van&apos;);</div><div class="line"></div><div class="line"></div><div class="line">CREATE TABLE `orders` (</div><div class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</div><div class="line">  `user_id` int(11) NOT NULL,</div><div class="line">  `price` decimal(8,2) NOT NULL,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  KEY `index_orders_on_user_id_and_price` (`user_id`,`price`)</div><div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div><div class="line">INSERT INTO orders(user_id, price) VALUES (1, 80);</div><div class="line">INSERT INTO orders(user_id, price) VALUES (1, 100);</div><div class="line">INSERT INTO orders(user_id, price) VALUES (2, 90);</div><div class="line">INSERT INTO orders(user_id, price) VALUES (2, 120);</div><div class="line"></div><div class="line"></div><div class="line">CREATE TABLE `order_items` (</div><div class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</div><div class="line">  `order_id` int(11) NOT NULL,</div><div class="line">  `product_name` varchar(50) NOT NULL,</div><div class="line">  `quantity` int(11) NOT NULL,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  KEY `index_order_items_on_order_id` (`order_id`),</div><div class="line">  KEY `index_order_items_on_product_name` (`product_name`)</div><div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div><div class="line">INSERT INTO order_items(order_id, product_name, quantity) VALUES (1, &apos;p1&apos;, 1);</div><div class="line">INSERT INTO order_items(order_id, product_name, quantity) VALUES (1, &apos;p2&apos;, 2);</div><div class="line">INSERT INTO order_items(order_id, product_name, quantity) VALUES (2, &apos;p3&apos;, 1);</div><div class="line">INSERT INTO order_items(order_id, product_name, quantity) VALUES (2, &apos;p4&apos;, 1);</div><div class="line">INSERT INTO order_items(order_id, product_name, quantity) VALUES (3, &apos;p5&apos;, 3);</div><div class="line">INSERT INTO order_items(order_id, product_name, quantity) VALUES (4, &apos;p6&apos;, 2);</div></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html" target="_blank" rel="external">EXPLAIN Output Format</a></li><li><a href="https://segmentfault.com/a/1190000008131735" target="_blank" rel="external">MySQL 性能优化神器 Explain 使用分析</a></li><li><a href="http://www.cnitblog.com/aliyiyi08/archive/2008/09/09/48878.html" target="_blank" rel="external">Mysql Explain 详解</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;EXPLAIN 解释了 MySQL 是如何执行 SQL 语句的。使用的方法很简单，在 SQL 语句前加上 &lt;code&gt;EXPLAIN&lt;/code&gt; 关键字就可以。&lt;br&gt;下面是一个简单的例子，测试数据在文章末尾。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;# 例 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; EXPLAIN SELECT name FROM users WHERE id = 1\G&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;*************************** 1. row ***************************&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           id: 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  select_type: SIMPLE&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        table: users&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         type: const&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;possible_keys: PRIMARY&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          key: PRIMARY&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      key_len: 4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;          ref: const&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         rows: 1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Extra: NULL&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1 row in set (0.00 sec)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;EXPLAIN 列的解释：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;id：SELECT 标识符，下面具体分析&lt;/li&gt;
&lt;li&gt;select_type: SELECT 类型，下面会具体分析&lt;/li&gt;
&lt;li&gt;table: 查询所使用的表&lt;/li&gt;
&lt;li&gt;type: JOIN 的类型，下面会具体分析&lt;/li&gt;
&lt;li&gt;possible_keys: 可能使用的索引，但不一定会真正使用&lt;/li&gt;
&lt;li&gt;key: 真正使用的索引&lt;/li&gt;
&lt;li&gt;key_len: 所使用的索引长度&lt;/li&gt;
&lt;li&gt;ref: 与索引比较的列&lt;/li&gt;
&lt;li&gt;rows: 预估需要扫描的行数&lt;/li&gt;
&lt;li&gt;Extra: 额外信息&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://kaywu.xyz/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://kaywu.xyz/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Rails Concern 源码研究</title>
    <link href="http://kaywu.xyz/2017/03/19/rails-concern/"/>
    <id>http://kaywu.xyz/2017/03/19/rails-concern/</id>
    <published>2017-03-19T10:07:19.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>ActiveSupport::Concern 是为了更方便地 include 模块而推出的工具类。</p><h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><p>首先来看下它的使用方法。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 传统的 Module 引入</span></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span></div><div class="line">    base.extend ClassMethods</div><div class="line">    base.class_eval <span class="keyword">do</span></div><div class="line">      scope <span class="symbol">:disabled</span>, -&gt; &#123; where(<span class="symbol">disabled:</span> <span class="literal">true</span>) &#125;</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">module</span> <span class="title">ClassMethods</span></span></div><div class="line">    ...</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment"># 使用 Concern</span></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></div><div class="line">  extend ActiveSupport::Concern</div><div class="line"></div><div class="line">  included <span class="keyword">do</span></div><div class="line">    scope <span class="symbol">:disabled</span>, -&gt; &#123; where(<span class="symbol">disabled:</span> <span class="literal">true</span>) &#125;</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  class_methods <span class="keyword">do</span></div><div class="line">    ...</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>可见，通过 included 和 class_method 两个类方法使得 Module 的写法更加清晰。<br>你可能有些疑问，对比传统的引入，使用 Concern 虽然更加清晰了，但没什么巨大的优点。而传统的引入也可以通过将方法分成两个 module，如 InstanceMethods、ClassMethods，来达到同样的效果。<br>在这个简单的例子上，确实如此。但在一些嵌套的 include 上 Concern 的优势就体现出来了。</p><a id="more"></a><h3 id="嵌套的-include"><a href="#嵌套的-include" class="headerlink" title="嵌套的 include"></a>嵌套的 include</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Foo</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span></div><div class="line">    base.class_eval <span class="keyword">do</span></div><div class="line">      <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">method_injected_by_foo</span></span></div><div class="line">        ...</div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Bar</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span></div><div class="line">    base.method_injected_by_foo</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Host</span></span></div><div class="line">  <span class="keyword">include</span> Foo <span class="comment"># We need to include this dependency for Bar</span></div><div class="line">  <span class="keyword">include</span> Bar <span class="comment"># Bar is the module that Host really needs</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure><p>我们需要在 Host 中引入 Bar，但由于 Bar 又需要 Foo，导致必须在 Host 中引入 Foo。也就是说，当我们 include module 时也必须把它的依赖同时 include 进来。这将随着依赖关系的复杂而变得艰难。<br>为什么不让 Bar 来负责自己的依赖呢？如以下的代码。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Bar</span></span></div><div class="line">  <span class="keyword">include</span> Foo</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span></div><div class="line">    base.method_injected_by_foo</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Host</span></span></div><div class="line">  <span class="keyword">include</span> Bar</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>然而愿望很美好，实际运行时会报错，让我们来分析下流程。<br>当 Bar include Foo 时， Foo::included 方法被回调，而此时的 base 为 Bar。也就是说，method_injected_by_foo 会被添加到 Bar 上而不是 Host。当 Host include Bar 时，Bar::included 会调用 Host::method_injected_by_foo，而 Host 上没有相关方法，导致报错。</p><p>但是使用 Concern 就可以完美地解决这个问题。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="string">'active_support/concern'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Foo</span></span></div><div class="line">  extend ActiveSupport::Concern</div><div class="line">  included <span class="keyword">do</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">method_injected_by_foo</span></span></div><div class="line">      ...</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Bar</span></span></div><div class="line">  extend ActiveSupport::Concern</div><div class="line">  <span class="keyword">include</span> Foo</div><div class="line"></div><div class="line">  included <span class="keyword">do</span></div><div class="line">    <span class="keyword">self</span>.method_injected_by_foo</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Host</span></span></div><div class="line">  <span class="keyword">include</span> Bar <span class="comment"># It works, now Bar takes care of its dependencies</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>Concern 的源码很短，不过 40 多行，但涉及到不少元编程的知识，要看明白得花点功夫。<br>复习下基本的知识，A extend B，B 的 extended 会被回调，参数 base 为 B。A include B，B 的 included、append_features 都会被回调，参数 base 为 B。</p><p>接下来，以上文 Concern 代码为例子来说明下实现原理。<br>我们先从 <code>module Foo extend ActiveSupport::Concern</code> 开始，此时 Concern::extended 会被回调，初始化 Foo 实例变量 @_dependencies。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">extended</span><span class="params">(base)</span></span> <span class="comment">#:nodoc:</span></div><div class="line">  base.instance_variable_set(<span class="symbol">:</span>@_dependencies, [])</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>之后第 5 行调用 included 时，会将 @_included_block 设置为传入的 block。<br>注意这里的 included 是显式调用的，而不是被回调的，参数 base 为 nil。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">included</span><span class="params">(base = <span class="literal">nil</span>, &amp;block)</span></span></div><div class="line">  <span class="keyword">if</span> base.<span class="literal">nil</span>?</div><div class="line">    raise MultipleIncludedBlocks <span class="keyword">if</span> instance_variable_defined?(<span class="symbol">:</span>@_included_block)</div><div class="line"></div><div class="line">    @_included_block = block</div><div class="line">  <span class="keyword">else</span></div><div class="line">    <span class="keyword">super</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>第 13 行 <code>module Bar extend ActiveSupport::Concern</code> 与 Foo extend Concern 同理。<br>第 14 行 <code>include Foo</code>，使得 Foo 的 append_features 和 included 被调用。included 由于 base 不为空只是简单地调用 super。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">append_features</span><span class="params">(base)</span></span></div><div class="line">  <span class="keyword">if</span> base.instance_variable_defined?(<span class="symbol">:</span>@_dependencies)</div><div class="line">    base.instance_variable_get(<span class="symbol">:</span>@_dependencies) &lt;&lt; <span class="keyword">self</span></div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">  <span class="keyword">else</span></div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> base &lt; <span class="keyword">self</span></div><div class="line">    @_dependencies.each &#123; <span class="params">|dep|</span> base.send(<span class="symbol">:include</span>, dep) &#125;</div><div class="line">    <span class="keyword">super</span></div><div class="line">    base.extend const_get(<span class="symbol">:ClassMethods</span>) <span class="keyword">if</span> const_defined?(<span class="symbol">:ClassMethods</span>)</div><div class="line">    base.class_eval(&amp;@_included_block) <span class="keyword">if</span> instance_variable_defined?(<span class="symbol">:</span>@_included_block)</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p><code>append_features</code> 是 Concern 实现其 magic 最重要的部分。<br>由于 Bar 初始化了 @_dependencies，<code>base.instance_variable_get(:@_dependencies) &lt;&lt; self</code> 会被运行，所以 Bar.@_dependencies 就变为了 [Foo]。<br>Bar 调用 included 和 Foo 同理。</p><p>第 22 行，<code>Host include Bar</code> 使得 Bar 的 append_features 被回调。注意注意，重头戏来了。<br><code>@_dependencies.each { |dep| base.send(:include, dep) }</code> 会被执行，通过之前的分析 Bar.@_dependencies 为 [Foo]，所以也就是 <code>base.send(:include, Foo)</code>，这里的 base 为 Host。Host include Foo 会回调 Foo 的 append_features，此时 Host 会 extend Foo::ClassMethods 和 class_eval(&amp;@_included_block)，从而实现了 Host 在 include Bar 时自动 include Foo。</p><p>最后附上 Concern 的源码。</p><h4 id="Concern-源码"><a href="#Concern-源码" class="headerlink" title="Concern 源码"></a>Concern 源码</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">ActiveSupport</span></span></div><div class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Concern</span></span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MultipleIncludedBlocks</span> &lt; StandardError <span class="comment">#:nodoc:</span></span></div><div class="line">      <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></div><div class="line">        <span class="keyword">super</span> <span class="string">"Cannot define multiple 'included' blocks for a Concern"</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">extended</span><span class="params">(base)</span></span> <span class="comment">#:nodoc:</span></div><div class="line">      base.instance_variable_set(<span class="symbol">:</span>@_dependencies, [])</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append_features</span><span class="params">(base)</span></span></div><div class="line">      <span class="keyword">if</span> base.instance_variable_defined?(<span class="symbol">:</span>@_dependencies)</div><div class="line">        base.instance_variable_get(<span class="symbol">:</span>@_dependencies) &lt;&lt; <span class="keyword">self</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">      <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> base &lt; <span class="keyword">self</span></div><div class="line">        @_dependencies.each &#123; <span class="params">|dep|</span> base.send(<span class="symbol">:include</span>, dep) &#125;</div><div class="line">        <span class="keyword">super</span></div><div class="line">        base.extend const_get(<span class="symbol">:ClassMethods</span>) <span class="keyword">if</span> const_defined?(<span class="symbol">:ClassMethods</span>)</div><div class="line">        base.class_eval(&amp;@_included_block) <span class="keyword">if</span> instance_variable_defined?(<span class="symbol">:</span>@_included_block)</div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">included</span><span class="params">(base = <span class="literal">nil</span>, &amp;block)</span></span></div><div class="line">      <span class="keyword">if</span> base.<span class="literal">nil</span>?</div><div class="line">        raise MultipleIncludedBlocks <span class="keyword">if</span> instance_variable_defined?(<span class="symbol">:</span>@_included_block)</div><div class="line"></div><div class="line">        @_included_block = block</div><div class="line">      <span class="keyword">else</span></div><div class="line">        <span class="keyword">super</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">class_methods</span><span class="params">(&amp;class_methods_module_definition)</span></span></div><div class="line">      mod = const_defined?(<span class="symbol">:ClassMethods</span>, <span class="literal">false</span>) ?</div><div class="line">        const_get(<span class="symbol">:ClassMethods</span>) <span class="symbol">:</span></div><div class="line">        const_set(<span class="symbol">:ClassMethods</span>, Module.new)</div><div class="line"></div><div class="line">      mod.module_eval(&amp;class_methods_module_definition)</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://api.rubyonrails.org/classes/ActiveSupport/Concern.html" target="_blank" rel="external">ActiveSupport::Concern 源码</a></li><li><a href="http://elfxp.com/intro-of-concerns-in-rails/" target="_blank" rel="external">Rails 源码赏析之 Concern</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ActiveSupport::Concern 是为了更方便地 include 模块而推出的工具类。&lt;/p&gt;
&lt;h3 id=&quot;使用方法&quot;&gt;&lt;a href=&quot;#使用方法&quot; class=&quot;headerlink&quot; title=&quot;使用方法&quot;&gt;&lt;/a&gt;使用方法&lt;/h3&gt;&lt;p&gt;首先来看下它的使用方法。&lt;br&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 传统的 Module 引入&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;M&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;self&lt;/span&gt;.&lt;span class=&quot;title&quot;&gt;included&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(base)&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    base.extend ClassMethods&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    base.class_eval &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      scope &lt;span class=&quot;symbol&quot;&gt;:disabled&lt;/span&gt;, -&amp;gt; &amp;#123; where(&lt;span class=&quot;symbol&quot;&gt;disabled:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;) &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;ClassMethods&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 使用 Concern&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;M&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  extend ActiveSupport::Concern&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  included &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    scope &lt;span class=&quot;symbol&quot;&gt;:disabled&lt;/span&gt;, -&amp;gt; &amp;#123; where(&lt;span class=&quot;symbol&quot;&gt;disabled:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;) &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  class_methods &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ...&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;可见，通过 included 和 class_method 两个类方法使得 Module 的写法更加清晰。&lt;br&gt;你可能有些疑问，对比传统的引入，使用 Concern 虽然更加清晰了，但没什么巨大的优点。而传统的引入也可以通过将方法分成两个 module，如 InstanceMethods、ClassMethods，来达到同样的效果。&lt;br&gt;在这个简单的例子上，确实如此。但在一些嵌套的 include 上 Concern 的优势就体现出来了。&lt;/p&gt;
    
    </summary>
    
      <category term="Rails" scheme="http://kaywu.xyz/categories/Rails/"/>
    
    
      <category term="Rails" scheme="http://kaywu.xyz/tags/Rails/"/>
    
  </entry>
  
  <entry>
    <title>Ruby 常量查找</title>
    <link href="http://kaywu.xyz/2017/02/19/ruby-constant/"/>
    <id>http://kaywu.xyz/2017/02/19/ruby-constant/</id>
    <published>2017-02-19T09:08:10.000Z</published>
    <updated>2017-10-10T15:25:40.000Z</updated>
    
    <content type="html"><![CDATA[<p>对 Ruby 中常量查找只有基础的认识，使用上还是有不少疑问，比如 “::A” 的含义、为什么有时使用 “A::B” 而有时直接用 “B”。<br>花时间查了资料来加深对此的理解。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Record</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">method</span></span></div><div class="line">    puts <span class="string">'outer'</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Music</span></span></div><div class="line"></div><div class="line">    Record.method <span class="comment"># outer</span></div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">module</span> <span class="title">Record</span></span></div><div class="line">      <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">method</span></span></div><div class="line">        puts <span class="string">'inner'</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    Record.method <span class="comment"># inner</span></div><div class="line">    <span class="symbol">:</span><span class="symbol">:Record</span>.method <span class="comment"># outer</span></div><div class="line">    Music::Record.method <span class="comment"># inner</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure><p>我们从简单的例子出发。在上文的代码中，共存在着两个名为 Record 的 module。一个是在最外层，一个是在 Music 内部。<br>当第 9 行调用 Record.method 时，由于 Music 内的 Record 还未被定义，因此调用的只能是最外层的 Record module。<br>而在第 17 行，当我们重新调用时，却发现调用的已经是内部的 Record 了。<br>可见常量的调用时是有一个先后顺序的，简单的说就是从近及远，先使用近的。虽然我们从直观上很容易理解近的含义，但严格上的顺序是通过 <code>Module.nesting</code> 得到的。在 Music 内部调用得到 [Record::Music, Record]，可见 Record::Music 确实比 Record 有更高的优先级。</p><a id="more"></a><p>我们再来看看 <code>::Record.method</code>，在使用 <code>::</code> 之后，调用的就变成了外层的 Record 。<code>::</code>的作用是从 top level 来查找相关常量，也就是调用最外层的 Record。</p><p><code>Record.method</code> 和 <code>Music::Record.method</code> 有什么区别吗？<br>若都能找到相同的对象，这两者是没有区别的，如 16、18 行。<br>但在 top level 中调用 <code>Music::Record.method</code> 时，需使用完整的路径 <code>Record::Music::Record.method</code>，不然会报 <code>uninitialized constant</code>。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Module.nesting 只是查找常量的一部分，更完整的常量查找步骤如下：</p><ol><li>向外找，从 Module.nesting 依次查找</li><li>向上找，从打开类 的 ancestors 依次查找（打开类：Module.nesting.first，若为空则为 Object）<br><a href="https://cirw.in/blog/constant-lookup" target="_blank" rel="external">Everything you ever wanted to know about constant lookup in Ruby</a> 讲得非常详情，就不多述了。</li></ol><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://cirw.in/blog/constant-lookup" target="_blank" rel="external">Everything you ever wanted to know about constant lookup in Ruby</a></li><li><a href="http://stackoverflow.com/questions/5032844/ruby-what-does-prefix-do" target="_blank" rel="external">Ruby: what does :: prefix do?</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;对 Ruby 中常量查找只有基础的认识，使用上还是有不少疑问，比如 “::A” 的含义、为什么有时使用 “A::B” 而有时直接用 “B”。&lt;br&gt;花时间查了资料来加深对此的理解。&lt;/p&gt;
&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Record&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;self&lt;/span&gt;.&lt;span class=&quot;title&quot;&gt;method&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    puts &lt;span class=&quot;string&quot;&gt;&#39;outer&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Music&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Record.method &lt;span class=&quot;comment&quot;&gt;# outer&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Record&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;self&lt;/span&gt;.&lt;span class=&quot;title&quot;&gt;method&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        puts &lt;span class=&quot;string&quot;&gt;&#39;inner&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Record.method &lt;span class=&quot;comment&quot;&gt;# inner&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;symbol&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;symbol&quot;&gt;:Record&lt;/span&gt;.method &lt;span class=&quot;comment&quot;&gt;# outer&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Music::Record.method &lt;span class=&quot;comment&quot;&gt;# inner&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们从简单的例子出发。在上文的代码中，共存在着两个名为 Record 的 module。一个是在最外层，一个是在 Music 内部。&lt;br&gt;当第 9 行调用 Record.method 时，由于 Music 内的 Record 还未被定义，因此调用的只能是最外层的 Record module。&lt;br&gt;而在第 17 行，当我们重新调用时，却发现调用的已经是内部的 Record 了。&lt;br&gt;可见常量的调用时是有一个先后顺序的，简单的说就是从近及远，先使用近的。虽然我们从直观上很容易理解近的含义，但严格上的顺序是通过 &lt;code&gt;Module.nesting&lt;/code&gt; 得到的。在 Music 内部调用得到 [Record::Music, Record]，可见 Record::Music 确实比 Record 有更高的优先级。&lt;/p&gt;
    
    </summary>
    
      <category term="Ruby" scheme="http://kaywu.xyz/categories/Ruby/"/>
    
    
      <category term="Ruby" scheme="http://kaywu.xyz/tags/Ruby/"/>
    
  </entry>
  
  <entry>
    <title>mac 上 MySQL system error 32 解决方案</title>
    <link href="http://kaywu.xyz/2017/01/21/mysql-system-error-32/"/>
    <id>http://kaywu.xyz/2017/01/21/mysql-system-error-32/</id>
    <published>2017-01-21T09:53:22.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>不知为何，在升级了 macOS 系统之后，Rails 连接 MySQL 经常性会报 <code>Mysql2::Error: Lost connection to MySQL server at &#39;sending authentication information&#39;, system error: 32</code> 的错误。重启 MySQL 就好了，过段时间又会报错，烦不胜烦。下定决心解决下。</p><p>参考了<a href="http://bugs.mysql.com/bug.php?id=71960" target="_blank" rel="external">这个帖子</a>后，大致看到有两种解决方法。一种是调大系统 <code>ulimit -n</code> 的值，另一种是调小 <code>table_open_cache</code> 的值。<br>从帖子的回复以及 <code>ulimit -n</code> 表示系统的文件句柄限制来看，个人认为调节 <code>ulimit -n</code> 的值是一个治标不治本的方法。本机的值已经 4k+，应该足够了。</p><p>正巧有次出现问题时，MySQL 还连接着。查了下当时的 status，发现 <code>open_tables</code> 不过几十，而 <code>open_files</code> 却几千。<br>执行 <code>flush tables</code> 清除缓存后就可以重新连接了。确实和 <code>table_open_cache</code> 有一定的关系。</p><p>查看了下 <code>table_open_cache</code> 的值，默认值是 2000。通过在 <code>my.cnf</code> 中添加 <code>table_open_cache = 500</code>，MySQL 这几天就没有闹别扭，希望能一直安稳下去。</p><h4 id="MySQL-相关命令"><a href="#MySQL-相关命令" class="headerlink" title="MySQL 相关命令"></a>MySQL 相关命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">show status like &apos;%open_files%&apos;; # 查看 open_files 的值，open_tables 同理</div><div class="line">show variables like &apos;%table_open_cache%&apos;; # 查看 table_open_cache 的值</div></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://bugs.mysql.com/bug.php?id=71960" target="_blank" rel="external">http://bugs.mysql.com/bug.php?id=71960</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;不知为何，在升级了 macOS 系统之后，Rails 连接 MySQL 经常性会报 &lt;code&gt;Mysql2::Error: Lost connection to MySQL server at &amp;#39;sending authentication information
      
    
    </summary>
    
      <category term="MySQL" scheme="http://kaywu.xyz/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://kaywu.xyz/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>ActiveRecord select vs pluck</title>
    <link href="http://kaywu.xyz/2017/01/15/rails-select-vs-pluck/"/>
    <id>http://kaywu.xyz/2017/01/15/rails-select-vs-pluck/</id>
    <published>2017-01-15T10:09:31.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>select</code>、<code>pluck</code> 都可以从数据库读取指定的字段，但两者存在不小的差别。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Product.select(<span class="symbol">:id</span>).to_a</div><div class="line"><span class="comment"># Product Load (0.5ms)  SELECT `products`.`id` FROM `products`</span></div><div class="line"><span class="comment"># [#&lt;Product id: 2&gt;, #&lt;Product id: 1&gt;]</span></div><div class="line"></div><div class="line">Product.pluck(<span class="symbol">:id</span>)</div><div class="line"><span class="comment"># Product Load (0.4ms)  SELECT `products`.`id` FROM `products`</span></div><div class="line"><span class="comment"># [2, 1]</span></div></pre></td></tr></table></figure><p><code>select</code> 返回的是仅含有 id 的 Product Model 数组，而 <code>pluck</code> 返回的是 id 的数组。<br>两者相比较，<code>pluck</code> 省却了构造 ActiveRecord 的过程，效率更优。我们可以通过 Benchmark.measure 来验证下。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">puts Benchmark.measure &#123;Product.select(<span class="symbol">:id</span>).to_a&#125;</div><div class="line">puts Benchmark.measure &#123;Product.pluck(<span class="symbol">:id</span>)&#125;</div></pre></td></tr></table></figure></p><table><thead><tr><th>-</th><th>user CPU time</th><th>system CPU time</th><th>sum CPU time</th><th>elapsed real time</th></tr></thead><tbody><tr><td>select</td><td>0.050000</td><td>0.020000</td><td>0.070000</td><td>0.095440</td></tr><tr><td>pluck</td><td>0.000000</td><td>0.000000</td><td>0.000000</td><td>0.001845</td></tr></tbody></table><p>除此之外，两者还有一个区别，即查询时机的不同。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ProductOrder.where.<span class="keyword">not</span>(<span class="symbol">id:</span> SubOrder.where(<span class="symbol">sub_order_no:</span> <span class="string">'001'</span>).pluck(<span class="symbol">:order_id</span>))</div><div class="line"> <span class="comment"># SELECT `orders`.* FROM `orders` WHERE `orders`.`type` IN ('ProductOrder') AND (`orders`.`id` NOT IN (SELECT `sub_orders`.`order_id` FROM `sub_orders` WHERE `sub_orders`.`sub_order_no` = '001'))</span></div><div class="line"></div><div class="line">ProductOrder.where.<span class="keyword">not</span>(<span class="symbol">id:</span> SubOrder.where(<span class="symbol">sub_order_no:</span> <span class="string">'001'</span>).pluck(<span class="symbol">:order_id</span>))</div><div class="line"><span class="comment"># SELECT `sub_orders`.`order_id` FROM `sub_orders` WHERE `sub_orders`.`sub_order_no` = '001'</span></div><div class="line"><span class="comment"># SELECT `orders`.* FROM `orders` WHERE `orders`.`type` IN ('ProductOrder') AND (`orders`.`id` != 3)</span></div></pre></td></tr></table></figure></p><p>在上面这个例子中，通过 <code>pluck</code> 的调用进行了两次查询，而 <code>select</code> 只进行了一次查询。可见调用 <code>pluck</code> 会立即进行数据库查询。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://gavinmiller.io/2013/getting-to-know-pluck-and-select/" target="_blank" rel="external">Getting to Know Pluck and Select</a></li><li><a href="http://findnerd.com/list/view/Select-Vs-Pluck-in-Rails/19258/" target="_blank" rel="external">Select Vs Pluck in Rails</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;code&gt;select&lt;/code&gt;、&lt;code&gt;pluck&lt;/code&gt; 都可以从数据库读取指定的字段，但两者存在不小的差别。&lt;/p&gt;
&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;
      
    
    </summary>
    
      <category term="Rails" scheme="http://kaywu.xyz/categories/Rails/"/>
    
    
      <category term="Rails" scheme="http://kaywu.xyz/tags/Rails/"/>
    
  </entry>
  
  <entry>
    <title>Rails ETag 应用</title>
    <link href="http://kaywu.xyz/2017/01/08/rails-etag/"/>
    <id>http://kaywu.xyz/2017/01/08/rails-etag/</id>
    <published>2017-01-08T10:13:24.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="使用-ETag-验证缓存"><a href="#使用-ETag-验证缓存" class="headerlink" title="使用 ETag 验证缓存"></a>使用 ETag 验证缓存</h2><p><img src="/img/etag.png" alt="etag.png-27.9kB"><br>来源：<a href="http://mohanraj-nagasamy.github.io/blog/2014/02/22/browser-cache-how-etags-works-in-rails-3-and-rails-4/" target="_blank" rel="external">Browser Cache: How ETags Works in Rails 3 and Rails 4</a><br>可以把 ETag 看成是响应的 token，客户端在下一个同样的请求中将其发送给服务器。服务器通过 token 来判断资源是否进行修改。若未修改，则返回 <code>304 Not Modified</code>，使客户端不需再去下载与缓存中已有的完全相同的字节。</p><h2 id="fresh-when"><a href="#fresh-when" class="headerlink" title="fresh_when"></a>fresh_when</h2><p>在 Rails 中，我们可以通过 <code>stale</code> 或 <code>fresh_when</code> 方法来显式地使用 ETag。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductsController</span> &lt; ApplicationController</span></div><div class="line"></div><div class="line">  <span class="comment"># This will automatically send back a :not_modified if the request is fresh,</span></div><div class="line">  <span class="comment"># and will render the default template (product.*) if it's stale.</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></div><div class="line">    @product = Product.find(params[<span class="symbol">:id</span>])</div><div class="line">    fresh_when <span class="symbol">last_modified:</span> @product.published_at.utc, <span class="symbol">etag:</span> @product</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>上例中通过 <code>@product.published_at.utc</code> 来判断资源是否过期。</p><h2 id="默认开启的-ETag"><a href="#默认开启的-ETag" class="headerlink" title="默认开启的 ETag"></a>默认开启的 ETag</h2><p>最近才发现不用 fresh_when 返回的请求也会自带 ETag，查了下原来 Rails 框架默认使用 Rack::ETag middleware，会自动给无 ETag 的 response 根据其 body 添加上 ETag。</p><a id="more"></a><p>相关代码如下：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># File 'lib/rack/etag.rb', line 24</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(env)</span></span></div><div class="line">  status, headers, body = @app.call(env)</div><div class="line"></div><div class="line">  <span class="keyword">if</span> etag_status?(status) &amp;&amp; etag_body?(body) &amp;&amp; !skip_caching?(headers)</div><div class="line">    original_body = body</div><div class="line">    digest, new_body = digest_body(body)</div><div class="line">    body = Rack::BodyProxy.new(new_body) <span class="keyword">do</span></div><div class="line">      original_body.close <span class="keyword">if</span> original_body.respond_to?(<span class="symbol">:close</span>)</div><div class="line">    <span class="keyword">end</span></div><div class="line">    headers[ETAG_STRING] = <span class="string">%(W/"<span class="subst">#&#123;digest&#125;</span>")</span> <span class="keyword">if</span> digest</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="keyword">unless</span> headers[CACHE_CONTROL]</div><div class="line">    <span class="keyword">if</span> digest</div><div class="line">      headers[CACHE_CONTROL] = @cache_control <span class="keyword">if</span> @cache_control</div><div class="line">    <span class="keyword">else</span></div><div class="line">      headers[CACHE_CONTROL] = @no_cache_control <span class="keyword">if</span> @no_cache_control</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  [status, headers, body]</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>那这种默认的 ETag 和 fresh_when 有什么区别呢？<br>主要区别是判定缓存命中的时机。fresh_when 通过指定的 last_modified 来判定是否命中，若命中则不需要进行渲染。而 默认的 ETag 是根据 response body 生成的，必须先进行模板文件的渲染。也就是说，fresh_when 的效率更高。但同样的，使用 fresh_when 必须准确地指定 last_modified 来判定缓存是否失效。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://mohanraj-nagasamy.github.io/blog/2014/02/22/browser-cache-how-etags-works-in-rails-3-and-rails-4/" target="_blank" rel="external">Browser Cache: How ETags Works in Rails 3 and Rails 4</a></li><li><a href="http://guides.rubyonrails.org/caching_with_rails.html" target="_blank" rel="external">Caching with Rails: An Overview</a></li><li><a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching" target="_blank" rel="external">HTTP Caching</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;使用-ETag-验证缓存&quot;&gt;&lt;a href=&quot;#使用-ETag-验证缓存&quot; class=&quot;headerlink&quot; title=&quot;使用 ETag 验证缓存&quot;&gt;&lt;/a&gt;使用 ETag 验证缓存&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/img/etag.png&quot; alt=&quot;etag.png-27.9kB&quot;&gt;&lt;br&gt;来源：&lt;a href=&quot;http://mohanraj-nagasamy.github.io/blog/2014/02/22/browser-cache-how-etags-works-in-rails-3-and-rails-4/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Browser Cache: How ETags Works in Rails 3 and Rails 4&lt;/a&gt;&lt;br&gt;可以把 ETag 看成是响应的 token，客户端在下一个同样的请求中将其发送给服务器。服务器通过 token 来判断资源是否进行修改。若未修改，则返回 &lt;code&gt;304 Not Modified&lt;/code&gt;，使客户端不需再去下载与缓存中已有的完全相同的字节。&lt;/p&gt;
&lt;h2 id=&quot;fresh-when&quot;&gt;&lt;a href=&quot;#fresh-when&quot; class=&quot;headerlink&quot; title=&quot;fresh_when&quot;&gt;&lt;/a&gt;fresh_when&lt;/h2&gt;&lt;p&gt;在 Rails 中，我们可以通过 &lt;code&gt;stale&lt;/code&gt; 或 &lt;code&gt;fresh_when&lt;/code&gt; 方法来显式地使用 ETag。&lt;br&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;ProductsController&lt;/span&gt; &amp;lt; ApplicationController&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# This will automatically send back a :not_modified if the request is fresh,&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;# and will render the default template (product.*) if it&#39;s stale.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;show&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    @product = Product.find(params[&lt;span class=&quot;symbol&quot;&gt;:id&lt;/span&gt;])&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    fresh_when &lt;span class=&quot;symbol&quot;&gt;last_modified:&lt;/span&gt; @product.published_at.utc, &lt;span class=&quot;symbol&quot;&gt;etag:&lt;/span&gt; @product&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;上例中通过 &lt;code&gt;@product.published_at.utc&lt;/code&gt; 来判断资源是否过期。&lt;/p&gt;
&lt;h2 id=&quot;默认开启的-ETag&quot;&gt;&lt;a href=&quot;#默认开启的-ETag&quot; class=&quot;headerlink&quot; title=&quot;默认开启的 ETag&quot;&gt;&lt;/a&gt;默认开启的 ETag&lt;/h2&gt;&lt;p&gt;最近才发现不用 fresh_when 返回的请求也会自带 ETag，查了下原来 Rails 框架默认使用 Rack::ETag middleware，会自动给无 ETag 的 response 根据其 body 添加上 ETag。&lt;/p&gt;
    
    </summary>
    
      <category term="Rails" scheme="http://kaywu.xyz/categories/Rails/"/>
    
    
      <category term="Rails" scheme="http://kaywu.xyz/tags/Rails/"/>
    
  </entry>
  
  <entry>
    <title>DOM 事件流</title>
    <link href="http://kaywu.xyz/2016/12/25/dom/"/>
    <id>http://kaywu.xyz/2016/12/25/dom/</id>
    <published>2016-12-25T09:45:15.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="事件流"><a href="#事件流" class="headerlink" title="事件流"></a>事件流</h3><p>“DOM2级事件”规定的事件流包括三个阶段：</p><ol><li>事件捕获阶段</li><li>处于目标阶段</li><li>事件冒泡阶段</li></ol><p>事件捕获的思想是不太具体的节点应该更早接收到事件，而最具体的节点应该最后接收到事件。事件捕获的用意在于在事件到达预定目标之前捕获它。<br>事件冒泡指事件开始时由最具体的元素接收，然后逐级向上传播到较为不具体的节点。</p><p><img src="/img/event_flow.png" alt="event_flow.png-69.4kB"><br>来源：<a href="https://www.w3.org/TR/DOM-Level-3-Events/#event-flow" target="_blank" rel="external">W3C</a><br>以上图的 HTML 页面为例，单击 <code>&lt;td&gt;</code> 会按照上图所示顺序触发事件。</p><h3 id="事件委托"><a href="#事件委托" class="headerlink" title="事件委托"></a>事件委托</h3><p>事件委托利用了事件冒泡，只指定一个事件处理程序，就可以管理某一类型的所有事件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;ul&gt;</div><div class="line">    &lt;li&gt;TODO 1&lt;/li&gt;</div><div class="line">    &lt;li&gt;TODO 2&lt;/li&gt;</div><div class="line">    &lt;li&gt;TODO 3&lt;/li&gt;</div><div class="line">&lt;/ui&gt;</div></pre></td></tr></table></figure></p><p>以上面的 HTML 代码为例，按照传统的做法，若要使每个列表项单击后执行相关操作，则需要分别为它们各自添加 click 事件，共 3 个事件。若后续增加了更多的列表项，还需额外为它们添加相应的事件。<br>而使用事件委托，则只需在 <code>&lt;ul&gt;</code> 上添加 click 事件即可。由于所有列表项都是这个元素的子节点，而且它们的事件会冒泡，所以单击事件最终会被 <code>&lt;ul&gt;</code> 的事件处理。与前面的传统做法相比，事件委托占用的内存更小且更为便捷。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>JavaScript 高级程序设计 第 13 章</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;事件流&quot;&gt;&lt;a href=&quot;#事件流&quot; class=&quot;headerlink&quot; title=&quot;事件流&quot;&gt;&lt;/a&gt;事件流&lt;/h3&gt;&lt;p&gt;“DOM2级事件”规定的事件流包括三个阶段：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;事件捕获阶段&lt;/li&gt;
&lt;li&gt;处于目标阶段&lt;/li&gt;
&lt;l
      
    
    </summary>
    
      <category term="Front-End" scheme="http://kaywu.xyz/categories/Front-End/"/>
    
    
      <category term="Front-End" scheme="http://kaywu.xyz/tags/Front-End/"/>
    
  </entry>
  
  <entry>
    <title>FactoryGirl 技巧</title>
    <link href="http://kaywu.xyz/2016/12/18/factory-girl/"/>
    <id>http://kaywu.xyz/2016/12/18/factory-girl/</id>
    <published>2016-12-18T09:18:19.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="简洁地设置-Association"><a href="#简洁地设置-Association" class="headerlink" title="简洁地设置 Association"></a>简洁地设置 Association</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">factory <span class="symbol">:post</span> <span class="keyword">do</span></div><div class="line">    association <span class="symbol">:author</span>, <span class="symbol">factory:</span> <span class="symbol">:author</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure><p>我们可以通过以上来设置相关的 association，但如果 association 的名字与它 factory 的名称是相同的，我们就可以省略其 factory 的设置。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">factory <span class="symbol">:post</span> <span class="keyword">do</span></div><div class="line">    auther</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">factory <span class="symbol">:post</span> <span class="keyword">do</span></div><div class="line">  title <span class="string">"A title"</span></div><div class="line"></div><div class="line">  factory <span class="symbol">:approved_post</span> <span class="keyword">do</span></div><div class="line">    approved <span class="literal">true</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">approved_post = create(<span class="symbol">:approved_post</span>)</div><div class="line">approved_post.title    <span class="comment"># =&gt; "A title"</span></div><div class="line">approved_post.approved <span class="comment"># =&gt; true</span></div></pre></td></tr></table></figure><p>也能明确指定 parent。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">factory <span class="symbol">:post</span> <span class="keyword">do</span></div><div class="line">  title <span class="string">"A title"</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">factory <span class="symbol">:approved_post</span>, <span class="symbol">parent:</span> <span class="symbol">:post</span> <span class="keyword">do</span></div><div class="line">  approved <span class="literal">true</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><a id="more"></a><h3 id="使用-Trait"><a href="#使用-Trait" class="headerlink" title="使用 Trait"></a>使用 Trait</h3><p>以 Order 为例，它有多个状态。为了设置不同状态的 Order，我们可以通过写多个 Order 的 factory 来完成。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">factory <span class="symbol">:order_paid</span> <span class="keyword">do</span></div><div class="line">    customer</div><div class="line">    state <span class="symbol">:paid</span></div><div class="line">    note <span class="string">'This is a paid order'</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">factory <span class="symbol">:order_unpaid</span> <span class="keyword">do</span></div><div class="line">    customer</div><div class="line">    state <span class="symbol">:unpaid</span></div><div class="line">    note <span class="string">'This is an unpaid order'</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>但如果 Order 的属性很多，这两个 factory 大部分都是重复的。可以使用 trait 来简化类似的 factory。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">factory <span class="symbol">:order</span> od</div><div class="line">    customer</div><div class="line">    note <span class="string">'This is a order'</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">trait <span class="symbol">:paid</span> <span class="keyword">do</span></div><div class="line">    state <span class="symbol">:paid</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">trait <span class="symbol">:unpaid</span> <span class="keyword">do</span></div><div class="line">    state <span class="symbol">:unpaid</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>要创建不同状态的 Order 时，使用 <code>create :order, :paid</code> 和 <code>create :order, :unpaid</code>。</p><h3 id="使用-Callback"><a href="#使用-Callback" class="headerlink" title="使用 Callback"></a>使用 Callback</h3><p>当 Model 有多个 association 时，而且多个 association 还存在一定的关系时，我们就不能简单地设置 association，这会使 association 的关系遭到破坏。<br>例如一个订单有多个子订单，而每个子订单都有一个物流信息。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span></span></div><div class="line">    has_many <span class="symbol">:shipments</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubOrder</span></span></div><div class="line">    has_one <span class="symbol">:shipment</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shipment</span></span></div><div class="line">    belongs_to <span class="symbol">:order</span></div><div class="line">    belongs_to <span class="symbol">:sub_order</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>若要创建 Shipment 的 factory，需注意到 order、sub_order 是有一定的关系的。<br>可以通过 FactoryGirl 的 before(:create) 回调来实现。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">factory <span class="symbol">:shipment</span> <span class="keyword">do</span></div><div class="line">    ...</div><div class="line">    before <span class="symbol">:create</span> <span class="keyword">do</span> <span class="params">|shipment|</span></div><div class="line">        order = create <span class="symbol">:order</span></div><div class="line">        sub_order = create <span class="symbol">:sub_order</span>, <span class="symbol">order:</span> order</div><div class="line">        shipment.order = order</div><div class="line">        shipment.sub_order = sub_order</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>除 before(:create) 外，还有 after(:build)、after(:create)、after(:stub)。</p><h3 id="设置-Transient-Attributes"><a href="#设置-Transient-Attributes" class="headerlink" title="设置 Transient Attributes"></a>设置 Transient Attributes</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">FactoryGirl.define <span class="keyword">do</span></div><div class="line">  factory <span class="symbol">:comment</span> <span class="keyword">do</span></div><div class="line">    author</div><div class="line">    body <span class="string">'Post body'</span></div><div class="line">    approved_at Date.new(<span class="number">2016</span>, <span class="number">12</span>, <span class="number">18</span>)</div><div class="line">    post</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  factory <span class="symbol">:post</span> <span class="keyword">do</span></div><div class="line">    title <span class="string">'New post'</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  trait <span class="symbol">:with_comments</span> <span class="keyword">do</span></div><div class="line">    after <span class="symbol">:create</span> <span class="keyword">do</span> <span class="params">|post|</span></div><div class="line">      create_list <span class="symbol">:comment</span>, <span class="number">3</span>, <span class="symbol">:post</span> =&gt; post</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure><p><code>create :post, :with_comments</code> 会创建带有 3 条 comment 的 post。但若我们只想要有 2 条 comment 呢？通过 transient attributes 可以在 create 时动态地更改 comment 的数量。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">FactoryGirl.define <span class="keyword">do</span></div><div class="line">  factory <span class="symbol">:comment</span> <span class="keyword">do</span></div><div class="line">    author</div><div class="line">    body <span class="string">'Post body'</span></div><div class="line">    approved_at Date.new(<span class="number">2016</span>, <span class="number">12</span>, <span class="number">18</span>)</div><div class="line">    post</div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  factory <span class="symbol">:post</span> <span class="keyword">do</span></div><div class="line">    title <span class="string">'New post'</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  trait <span class="symbol">:with_comments</span> <span class="keyword">do</span></div><div class="line">    transient <span class="keyword">do</span></div><div class="line">        comments_count <span class="number">3</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">    after <span class="symbol">:create</span> <span class="keyword">do</span> <span class="params">|post, evaluator|</span></div><div class="line">      create_list <span class="symbol">:comment</span>, evaluator.comments_count, <span class="symbol">:post</span> =&gt; post</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>调用 <code>create :post, :with_comments, comments_count: 2</code> 即可。</p><h3 id="Lazy-Attributes"><a href="#Lazy-Attributes" class="headerlink" title="Lazy Attributes"></a>Lazy Attributes</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">factory <span class="symbol">:product</span> <span class="keyword">do</span></div><div class="line">    ...</div><div class="line">    name Faker::Name.name</div><div class="line">    ...</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure><p>这里使用 Faker 来动态生成名字。但是调用 <code>create :product</code> 多次后你会发现它们的名字都是相同的。若想在每次创建实例时重新执行 <code>Faker::Name.name</code>，<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">factory <span class="symbol">:product</span> <span class="keyword">do</span></div><div class="line">    ...</div><div class="line">    name &#123; Faker::Name.name &#125;</div><div class="line">    ...</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>这样生成实例时都会调用 <code>Faker::Name.name</code>。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://arjanvandergaag.nl/blog/factory_girl_tips.html" target="_blank" rel="external">FactoryGirl Tips and Tricks</a></li><li><a href="https://github.com/thoughtbot/factory_girl/blob/master/GETTING_STARTED.md" target="_blank" rel="external">FactoryGirl - Getting Started</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;简洁地设置-Association&quot;&gt;&lt;a href=&quot;#简洁地设置-Association&quot; class=&quot;headerlink&quot; title=&quot;简洁地设置 Association&quot;&gt;&lt;/a&gt;简洁地设置 Association&lt;/h3&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;factory &lt;span class=&quot;symbol&quot;&gt;:post&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    association &lt;span class=&quot;symbol&quot;&gt;:author&lt;/span&gt;, &lt;span class=&quot;symbol&quot;&gt;factory:&lt;/span&gt; &lt;span class=&quot;symbol&quot;&gt;:author&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们可以通过以上来设置相关的 association，但如果 association 的名字与它 factory 的名称是相同的，我们就可以省略其 factory 的设置。&lt;br&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;factory &lt;span class=&quot;symbol&quot;&gt;:post&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    auther&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;继承&quot;&gt;&lt;a href=&quot;#继承&quot; class=&quot;headerlink&quot; title=&quot;继承&quot;&gt;&lt;/a&gt;继承&lt;/h3&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;factory &lt;span class=&quot;symbol&quot;&gt;:post&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  title &lt;span class=&quot;string&quot;&gt;&quot;A title&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  factory &lt;span class=&quot;symbol&quot;&gt;:approved_post&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    approved &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;approved_post = create(&lt;span class=&quot;symbol&quot;&gt;:approved_post&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;approved_post.title    &lt;span class=&quot;comment&quot;&gt;# =&amp;gt; &quot;A title&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;approved_post.approved &lt;span class=&quot;comment&quot;&gt;# =&amp;gt; true&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;也能明确指定 parent。&lt;br&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;factory &lt;span class=&quot;symbol&quot;&gt;:post&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  title &lt;span class=&quot;string&quot;&gt;&quot;A title&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;factory &lt;span class=&quot;symbol&quot;&gt;:approved_post&lt;/span&gt;, &lt;span class=&quot;symbol&quot;&gt;parent:&lt;/span&gt; &lt;span class=&quot;symbol&quot;&gt;:post&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  approved &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Ruby" scheme="http://kaywu.xyz/categories/Ruby/"/>
    
    
      <category term="Ruby" scheme="http://kaywu.xyz/tags/Ruby/"/>
    
  </entry>
  
  <entry>
    <title>Javascript == 和 === 区别</title>
    <link href="http://kaywu.xyz/2016/12/16/js-equal/"/>
    <id>http://kaywu.xyz/2016/12/16/js-equal/</id>
    <published>2016-12-16T09:48:31.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h2><p>最主要的区别，== 会在比较前进行转化，而 === 比较前不进行转化。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var result1 = (&apos;55&apos; == 55) // true，因为转换后相等</div><div class="line">var result2 = (&apos;55&apos; === 55) // false，因为不同的数据类型不相等</div></pre></td></tr></table></figure></p><h2 id="相等"><a href="#相等" class="headerlink" title="相等 =="></a>相等 ==</h2><p>相等操作符会先转换操作数（通常称为强制转型），然后再比较它们的相等性。</p><p>在转换时：<br>如果有一个操作数是布尔值，则在比较相等性之前将其转换为数值—— false 为 0，true 为 1。<br>如果一个操作数是字符串，另一个操作数是数值，在比较相等性之前先将字符串转换为数值。<br>如果一个操作数是对象，另一个操作数不是，则调用对象的 valueOf() 方法，用得到的基本类型值按照前面的规则进行比较。</p><p>在比较时：<br>null 和 undefined 是相等的。<br>要比较相等性之前，不能将 null 和 undefined 转换成其他任何值。<br>如果有一个操作数是 NaN（两个 NaN也是），则相等操作符返回 false。<br>如果两个操作数都是对象，则比较它们是不是同一个对象。如果指向同一个对象则返回 true。</p><h2 id="全等"><a href="#全等" class="headerlink" title="全等 ==="></a>全等 ===</h2><p>除了在比较之前不转换操作数之外，全等和不全等操作符与相等和不相等操作符没有什么区别。它只在两个操作数未经转换就相等的情况下返回 true。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>JavaScript 高级程序设计 P52</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;比较&quot;&gt;&lt;a href=&quot;#比较&quot; class=&quot;headerlink&quot; title=&quot;比较&quot;&gt;&lt;/a&gt;比较&lt;/h2&gt;&lt;p&gt;最主要的区别，== 会在比较前进行转化，而 === 比较前不进行转化。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;
      
    
    </summary>
    
      <category term="Front-End" scheme="http://kaywu.xyz/categories/Front-End/"/>
    
    
      <category term="Front-End" scheme="http://kaywu.xyz/tags/Front-End/"/>
    
  </entry>
  
  <entry>
    <title>Rails &amp; MySQL 使用 emoji 时 Incorrect string value 解决方法</title>
    <link href="http://kaywu.xyz/2016/12/04/mysql-emoji/"/>
    <id>http://kaywu.xyz/2016/12/04/mysql-emoji/</id>
    <published>2016-12-04T09:50:50.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>当在 charset 为 utf-8 的 MySQL 中插入 emoji 时，数据库会报错 <code>Incorrect string value</code>。<br>仔细一想，这很奇怪。因为 emoji 本身可以通过 utf-8 来表示，作为 utf-8 的 MySQL 表来说报错实在是太不应该了。<br>查了之后，才发现原来 MySQL 的 utf-8 是不完全的，只支持 1-3 个字节，而 emoji 的 utf-8 编码大多为 4 个字节。为了支持更多的字符集，MySQL 5.5 推出了编码 utf8mb4，使其可以兼容 4 字节的 emoji。<br>因此，若要让数据库支持 emoji，可以将编码从 utf-8 改为 utf8mb4。</p><p>对于新创建的表这样没有问题，但对于旧有的表来说更改字符集代价很大。有没有一个更简单的方法来实现呢？<br>对 Rails 来说是有的。可以通过 <code>serialize</code> 来实现。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> &lt; ActiveRecord::Base</span></div><div class="line">    serialize <span class="symbol">:content</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>这时存储 emoji 时，就会先进行 serialize 再存入数据库。由于不是直接以 emoji 的 utf-8 编码存储，MySQL 也就不会报错了。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://dev.firmafon.dk/blog/quick-no-hack-emoji-support-with-mysql-rails/" target="_blank" rel="external">Quick, no-hack emoji support with MySQL &amp; Rails</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;当在 charset 为 utf-8 的 MySQL 中插入 emoji 时，数据库会报错 &lt;code&gt;Incorrect string value&lt;/code&gt;。&lt;br&gt;仔细一想，这很奇怪。因为 emoji 本身可以通过 utf-8 来表示，作为 utf-8 的 MySQ
      
    
    </summary>
    
      <category term="MySQL" scheme="http://kaywu.xyz/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://kaywu.xyz/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Rails form_for 源码阅读</title>
    <link href="http://kaywu.xyz/2016/11/27/rails-form-for/"/>
    <id>http://kaywu.xyz/2016/11/27/rails-form-for/</id>
    <published>2016-11-27T10:15:49.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>初学 Rails 时，觉得 form_for 很强大，这么简单就能完成一个表单。<br>现在想来，它其实就是通过配置来输出 Html。但由于做法很巧妙，使用时颇为爽快。<br>于是阅读下源码来研究下它的神奇之处。</p><h4 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;%= form_for @person <span class="keyword">do</span> <span class="params">|f|</span> %&gt;</div><div class="line">  &lt;%= f.label <span class="symbol">:first_name</span> %&gt;<span class="symbol">:</span></div><div class="line">  &lt;%= f.text_field <span class="symbol">:first_name</span> %&gt;&lt;br /&gt;</div><div class="line"></div><div class="line">  &lt;%= f.label <span class="symbol">:last_name</span> %&gt;<span class="symbol">:</span></div><div class="line">  &lt;%= f.text_field <span class="symbol">:last_name</span> %&gt;&lt;br /&gt;</div><div class="line"></div><div class="line">  &lt;%= f.submit %&gt;</div><div class="line">&lt;% <span class="keyword">end</span> %&gt;</div></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/people"</span> <span class="attr">class</span>=<span class="string">"new_person"</span> <span class="attr">id</span>=<span class="string">"new_person"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"authenticity_token"</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">value</span>=<span class="string">"NrOp5bsjoLRuK8IW5+dQEYjKGUJDe7TQoZVvq95Wteg="</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"person_first_name"</span>&gt;</span>First name<span class="tag">&lt;/<span class="name">label</span>&gt;</span>:</div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"person_first_name"</span> <span class="attr">name</span>=<span class="string">"person[first_name]"</span> <span class="attr">type</span>=<span class="string">"text"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"person_last_name"</span>&gt;</span>Last name<span class="tag">&lt;/<span class="name">label</span>&gt;</span>:</div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"person_last_name"</span> <span class="attr">name</span>=<span class="string">"person[last_name]"</span> <span class="attr">type</span>=<span class="string">"text"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"commit"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Create Person"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure><a id="more"></a><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># form_for 源码</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">form_for</span><span class="params">(record, options = &#123;&#125;, &amp;block)</span></span></div><div class="line">    raise ArgumentError, <span class="string">"Missing block"</span> <span class="keyword">unless</span> block_given?</div><div class="line">    html_options = options[<span class="symbol">:html</span>] <span class="params">||</span>= &#123;&#125;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> record</div><div class="line">    <span class="keyword">when</span> String, Symbol</div><div class="line">      object_name = record</div><div class="line">      object      = <span class="literal">nil</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">      object      = record.is_a?(Array) ? record.last : record</div><div class="line">      raise ArgumentError, <span class="string">"First argument in form cannot contain nil or be empty"</span> <span class="keyword">unless</span> object</div><div class="line">      object_name = options[<span class="symbol">:as</span>] <span class="params">||</span> model_name_from_record_or_class(object).param_key</div><div class="line">      apply_form_for_options!(record, object, options)</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    html_options[<span class="symbol">:data</span>]   = options.delete(<span class="symbol">:data</span>)   <span class="keyword">if</span> options.has_key?(<span class="symbol">:data</span>)</div><div class="line">    html_options[<span class="symbol">:remote</span>] = options.delete(<span class="symbol">:remote</span>) <span class="keyword">if</span> options.has_key?(<span class="symbol">:remote</span>)</div><div class="line">    html_options[<span class="symbol">:method</span>] = options.delete(<span class="symbol">:method</span>) <span class="keyword">if</span> options.has_key?(<span class="symbol">:method</span>)</div><div class="line">    html_options[<span class="symbol">:enforce_utf8</span>] = options.delete(<span class="symbol">:enforce_utf8</span>) <span class="keyword">if</span> options.has_key?(<span class="symbol">:enforce_utf8</span>)</div><div class="line">    html_options[<span class="symbol">:authenticity_token</span>] = options.delete(<span class="symbol">:authenticity_token</span>)</div><div class="line"></div><div class="line">    builder = instantiate_builder(object_name, object, options)</div><div class="line">    output  = capture(builder, &amp;block)</div><div class="line">    html_options[<span class="symbol">:multipart</span>] <span class="params">||</span>= builder.multipart?</div><div class="line"></div><div class="line">    html_options = html_options_for_form(options[<span class="symbol">:url</span>] <span class="params">||</span> &#123;&#125;, html_options)</div><div class="line">    form_tag_with_body(html_options, output)</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure><ul><li><p>form_for 如何获得 @person 的 model name？<br>通过 <code>model_name_from_record_or_class(object).param_key</code> 方法。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">ActionView</span></span></div><div class="line">  <span class="class"><span class="keyword">module</span> <span class="title">ModelNaming</span></span></div><div class="line">    <span class="comment"># Converts the given object to an ActiveModel compliant one.</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">convert_to_model</span><span class="params">(object)</span></span></div><div class="line">      object.respond_to?(<span class="symbol">:to_model</span>) ? object.to_model : object</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">model_name_from_record_or_class</span><span class="params">(record_or_class)</span></span></div><div class="line">      convert_to_model(record_or_class).model_name</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></li><li><p>如何判断 @person 是 create 还是 update?<br>通过 <code>persisted?</code> 来判断。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># apply_from_for_options 中的代码</span></div><div class="line">...</div><div class="line">action, method = object.respond_to?(<span class="symbol">:persisted?</span>) &amp;&amp; object.persisted? ? [<span class="symbol">:edit</span>, <span class="symbol">:patch</span>] : [<span class="symbol">:new</span>, <span class="symbol">:post</span>]</div><div class="line">...</div></pre></td></tr></table></figure></li><li><p>FormBuilder 的作用是？</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># FormBuilder</span></div><div class="line">(field_helpers - [<span class="symbol">:label</span>, <span class="symbol">:check_box</span>, <span class="symbol">:radio_button</span>, <span class="symbol">:fields_for</span>, <span class="symbol">:hidden_field</span>, <span class="symbol">:file_field</span>]).each <span class="keyword">do</span> <span class="params">|selector|</span></div><div class="line">    class_eval &lt;&lt;-RUBY_EVAL, __FILE_<span class="number">_</span>, __LINE_<span class="number">_</span> + <span class="number">1</span></div><div class="line">      <span class="function"><span class="keyword">def</span> <span class="comment">#&#123;selector&#125;(method, options = &#123;&#125;)  # def text_field(method, options = &#123;&#125;)</span></span></div><div class="line">        @template.send(                      <span class="comment">#   <span class="doctag">@template</span>.send(</span></div><div class="line">          <span class="comment">#&#123;selector.inspect&#125;,               #     "text_field",</span></div><div class="line">          @object_name,                      <span class="comment">#     <span class="doctag">@object</span>_name,</span></div><div class="line">          method,                            <span class="comment">#     method,</span></div><div class="line">          objectify_options(options))        <span class="comment">#     objectify_options(options))</span></div><div class="line">      <span class="keyword">end</span>                                    <span class="comment"># end</span></div><div class="line">    RUBY_EVAL</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></li></ul><p>以上是 FormBuilder 中的一段代码，其中 @template 代表的是 FormHelper。可以看出，FormBuilder 其实是一个 FormHelper 方法的代理类。<br>那为什么不直接使用 FormHelper？我的理解是，通过加入一层抽象，增加了灵活性。比如可以通过扩展 FormBuilder 来实现自定义的表单功能。</p><ul><li>最终的 html 是怎么生成的？<br>在 <code>capture(builder, &amp;block)</code> 中通过 FormBuilder 的方法来生成第一步的html，再通过 <code>form_tag_with_body(html_options, output)</code> 替换掉生成 html 中的 form_tag，形成最终版。<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">capture</span><span class="params">(*args)</span></span></div><div class="line">    value = <span class="literal">nil</span></div><div class="line">    buffer = with_output_buffer &#123; value = <span class="keyword">yield</span>(*args) &#125;</div><div class="line">    <span class="keyword">if</span> string = buffer.presence <span class="params">||</span> value <span class="keyword">and</span> string.is_a?(String)</div><div class="line">      ERB::Util.html_escape string</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;初学 Rails 时，觉得 form_for 很强大，这么简单就能完成一个表单。&lt;br&gt;现在想来，它其实就是通过配置来输出 Html。但由于做法很巧妙，使用时颇为爽快。&lt;br&gt;于是阅读下源码来研究下它的神奇之处。&lt;/p&gt;
&lt;h4 id=&quot;如何使用&quot;&gt;&lt;a href=&quot;#如何使用&quot; class=&quot;headerlink&quot; title=&quot;如何使用&quot;&gt;&lt;/a&gt;如何使用&lt;/h4&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;%= form_for @person &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;|f|&lt;/span&gt; %&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;lt;%= f.label &lt;span class=&quot;symbol&quot;&gt;:first_name&lt;/span&gt; %&amp;gt;&lt;span class=&quot;symbol&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;lt;%= f.text_field &lt;span class=&quot;symbol&quot;&gt;:first_name&lt;/span&gt; %&amp;gt;&amp;lt;br /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;lt;%= f.label &lt;span class=&quot;symbol&quot;&gt;:last_name&lt;/span&gt; %&amp;gt;&lt;span class=&quot;symbol&quot;&gt;:&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;lt;%= f.text_field &lt;span class=&quot;symbol&quot;&gt;:last_name&lt;/span&gt; %&amp;gt;&amp;lt;br /&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &amp;lt;%= f.submit %&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;lt;% &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt; %&amp;gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;form&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;action&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;/people&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;new_person&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;id&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;new_person&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;method&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;post&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;input&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;authenticity_token&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;hidden&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;value&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;NrOp5bsjoLRuK8IW5+dQEYjKGUJDe7TQoZVvq95Wteg=&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;label&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;for&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;person_first_name&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;First name&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;label&lt;/span&gt;&amp;gt;&lt;/span&gt;:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;input&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;id&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;person_first_name&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;person[first_name]&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;text&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;br&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;label&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;for&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;person_last_name&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;Last name&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;label&lt;/span&gt;&amp;gt;&lt;/span&gt;:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;input&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;id&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;person_last_name&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;person[last_name]&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;text&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;br&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;input&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;commit&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;submit&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;value&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;Create Person&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;form&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Rails" scheme="http://kaywu.xyz/categories/Rails/"/>
    
    
      <category term="Rails" scheme="http://kaywu.xyz/tags/Rails/"/>
    
  </entry>
  
  <entry>
    <title>Ruby super 关键字</title>
    <link href="http://kaywu.xyz/2016/11/20/ruby-super/"/>
    <id>http://kaywu.xyz/2016/11/20/ruby-super/</id>
    <published>2016-11-20T09:05:19.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>由于之前没接触过 Ruby super 的用法，想当然地按照 Java 的方法来使用，闹出了一个匪夷所思的 Bug。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">a_method</span><span class="params">(arg)</span></span></div><div class="line">        arg</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &lt; A</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">a_method</span><span class="params">(arg)</span></span></div><div class="line">        <span class="keyword">super</span>.a_method(arg)</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">B.new.a_method(<span class="number">1</span>) <span class="comment"># =&gt; NoMethodError: undefined method `a_method' for 1:Fixnum</span></div></pre></td></tr></table></figure><p>查了下才知，原来在 Ruby 中调用父类的同名方法， 只需使用 super，而不需再加上方法的名字。<br>上述代码改成如下即可。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &lt; A</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">a_method</span><span class="params">(arg)</span></span></div><div class="line">        <span class="keyword">super</span>(arg)</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>那想调用父类的其他方法要如何？可以使用 <code>method(:foo).super_method.call</code> 来调用父类的 foo 方法。</p><p>编程这事，果然不能想当然，不然坑得是自己。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://stackoverflow.com/questions/2564391/how-do-i-call-a-super-class-method" target="_blank" rel="external">http://stackoverflow.com/questions/2564391/how-do-i-call-a-super-class-method</a></li><li><a href="http://ruby-doc.org/docs/keywords/1.9/files/keywords_rb.html#M000034" target="_blank" rel="external">http://ruby-doc.org/docs/keywords/1.9/files/keywords_rb.html#M000034</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;由于之前没接触过 Ruby super 的用法，想当然地按照 Java 的方法来使用，闹出了一个匪夷所思的 Bug。&lt;/p&gt;
&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div cla
      
    
    </summary>
    
      <category term="Ruby" scheme="http://kaywu.xyz/categories/Ruby/"/>
    
    
      <category term="Ruby" scheme="http://kaywu.xyz/tags/Ruby/"/>
    
  </entry>
  
  <entry>
    <title>Ruby 元编程</title>
    <link href="http://kaywu.xyz/2016/10/16/meta-programming/"/>
    <id>http://kaywu.xyz/2016/10/16/meta-programming/</id>
    <published>2016-10-16T08:49:33.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Ch-1"><a href="#Ch-1" class="headerlink" title="Ch.1"></a>Ch.1</h2><h3 id="打开类"><a href="#打开类" class="headerlink" title="打开类"></a>打开类</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">x</span>;</span> <span class="string">'x'</span>; <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">y</span>;</span> <span class="string">'y'</span>; <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line">obj = D.new</div><div class="line">obj.x <span class="comment"># =&gt; 'x'</span></div><div class="line">obj.y <span class="comment"># =&gt; 'y'</span></div></pre></td></tr></table></figure><p>在上面的代码中，当第一次提及 class D 时，还没有一个叫做 D 的类存在。因此，Ruby 开始着手定义这个类，并定义 x() 方法。在第二次提及 D 类时，它已经存在，Ruby 就不用再定义它了。Ruby 只要重新打开这个已经存在的类，并为之定义 y() 方法。从某种意义上说，Rub y的 class 关键字更像是一个作用域操作符而不是类型声明语句。它的确可以创建一个还不存在的类，不过也可以把这看成是一种副作用。对于 class 关键字，其核心任务是把你带到类的上下文中，让你可以在其中定义方法。</p><a id="more"></a><h3 id="对象中有什么"><a href="#对象中有什么" class="headerlink" title="对象中有什么"></a>对象中有什么</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">my_method</span></span></div><div class="line">    @v = <span class="number">1</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">obj = MyClass.new</div><div class="line">obj.<span class="keyword">class</span>           <span class="comment"># =&gt; MyClass</span></div></pre></td></tr></table></figure><p>与 Java 这样的静态语言不一样，Ruby 中对象的类和它的实例变量没有关系，当给实例变量赋值时，它们就生成了。因此，对同一个类，你可以创建具有不同实例变量的对象。例如，如果 Bill 不曾调用 obj.my_method() 方法，那么 obj 对象根本不会有任何实例变量。你可以把 Ruby 中实例变量的名字和值理解为哈希表中的键/值对，每一个对象的键/值对都可能不同。<br>一个对象的实例变量存在于对象本身，而一个对象的方法存在于对象自身的类。这就是为什么同一个类的对象共享同样的方法，但不共享实例变量的原因。<br>既然类是对象，那么适用于对象的规则也适用于类。类和其他任何对象一样，也有自己的类，它的名字叫做 Class：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="string">"hello"</span>.<span class="keyword">class</span> <span class="comment"># =&gt; String</span></div><div class="line">String.<span class="keyword">class</span>  <span class="comment"># =&gt; Class</span></div><div class="line"></div><div class="line">String.superclass <span class="comment"># =&gt; Object</span></div><div class="line">Object.superclass <span class="comment"># =&gt; BaseObject</span></div><div class="line">BaseObject.suberclass <span class="comment"># =&gt; nil</span></div></pre></td></tr></table></figure></p><p>所有的类最终都继承于 Object，Object 本身又继承于 BasicObject，BasicObject 是 Ruby 对象体系中的根节点。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Class.superclass <span class="comment"># =&gt; Module</span></div><div class="line">Module.superclass <span class="comment"># =&gt; Object</span></div></pre></td></tr></table></figure></p><p>一个类只不过是一个增强的 Module，增强了三个方法——— new()、allocate()、superclass() 而已。<br><img src="/img/class.jpg" alt="class.jpg-50.4kB"></p><p>任何以大写字母开头的引用（包括类名和模块名），都是常量。常量的作用域不同于变量的作用域。<br>常量可以通过路径方式来唯一标识。常量路径使用双冒号进行分隔。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">C</span></span></div><div class="line">        X = <span class="string">'a constant'</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    C::X <span class="comment"># =&gt; 'a constant'</span></div><div class="line"><span class="keyword">end</span></div><div class="line">M::C::X <span class="comment"># =&gt; 'a constant'</span></div><div class="line"></div><div class="line"><span class="comment"># 在常量前加一组双冒号表示根路径，从而得到一个绝对路径</span></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></div><div class="line">    Y = <span class="string">'another constant'</span></div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">C</span></span></div><div class="line">        <span class="symbol">:</span><span class="symbol">:M</span><span class="symbol">:</span><span class="symbol">:Y</span> <span class="comment"># =&gt; 'another constant'</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>什么是对象？对象无非是一组实例变量外加一个指向其类的引用。对象的方法并不存在于对象本身，而是存在于对象的类中。在类中，这些方法被称为类的实例方法。<br>什么是类？类无非就是一个对象（Class 类的一个实例）外加一组实例方法和一个对其超类的引用。Class 类是 Module 类的子类，因此一个类也是一个模块。</p><h2 id="调用一个方法时发生了什么"><a href="#调用一个方法时发生了什么" class="headerlink" title="调用一个方法时发生了什么"></a>调用一个方法时发生了什么</h2><p>当调用过一个方法时，Ruby 会做两件事</p><ol><li>找到这个方法。这个过程称为方法查找。</li><li>执行这个方法。为了做到这点，Ruby 需要一个叫做 self 的东西。</li></ol><p>接受者就是你调用方法所在的对象。例如，在 my_string.reverse() 语句中，my_string 就是接收者。<br>想象从一个类移动到它的超类，然后再移动到超类的超类，依此类推，直到到达 Object 类（所有类的默认超类），最后来到 BasicObject 类（Ruby 类体系结构的根节点）。在这个过程中，你所经历的类路径就是该类的祖先链。<br>方法查找：为了查找一个方法，Ruby 首先在接收者的类中查找，然后一层层地在祖先链中查找，直到找到这个方法为止。</p><p>当你在一个类（甚至可以是另外一个模块）中包含（include）一个模块时，Ruby 耍了些小花招。Ruby 创建了一个封装该模块的匿名类，并把这个匿名类插入到祖先链中，其在链中的位置正好包含在它的类上方。<br><img src="/img/ancestors.jpg" alt="包含模块的方法查找"><br>Object 类包含了 Kernel 模块，因此 Kernel 就进入了每个对象的祖先链。这样在某个对象中可以随意调用 Kernel 模块的方法。这使得 print 看起来像是一个语言的关键字，其实它不过是一个方法而已。<br>每一行代码都会在一个对象中被执行———这个对象就是所谓的当前对象。当前对象也可以用 self 表示，因为可以用 self 关键字来访问它。<br>在给定时刻，只有一个对象能充当当前对象，但没有哪个对象能长期充当这一角色。特别地，当调用一个方法时，接收者就成为 self。从这一刻起，所有的实例变量都是self的实例变量，所有没有明确指明接收者的方法都在 self 上调用。当你的代码调用其他对象的方法时，这个对象就成为 self。<br>私有方法服从一个简单的规则：不能明确指定一个接收者来调用一个私有方法。换言之，每次调用一个私有方法时，只能调用于隐含的接收者—— self 上。</p><h2 id="Ch-2"><a href="#Ch-2" class="headerlink" title="Ch.2"></a>Ch.2</h2><h3 id="动态方法"><a href="#动态方法" class="headerlink" title="动态方法"></a>动态方法</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_method</span><span class="params">(my_arg)</span></span></div><div class="line">        my_arg * <span class="number">2</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line">obj = MyClass.new</div><div class="line">obj.my_method(<span class="number">3</span>)</div><div class="line">obj.send(<span class="symbol">:my_method</span>, <span class="number">3</span>)</div></pre></td></tr></table></figure><p>通过 send() 方法，你想调用的方法名可以成为一个参数，这样就可以在代码运行期间，直到最后一刻才决定调用哪个方法。这种技术称为动态派发。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></div><div class="line">    define_method <span class="symbol">:my_method</span> <span class="keyword">do</span> <span class="params">|my_arg|</span></div><div class="line">        my_args * <span class="number">3</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">obj = MyClass.new</div><div class="line">obj.my_method(<span class="number">2</span>)</div></pre></td></tr></table></figure><p>define_method() 方法在 MyClass 内部执行，因此 my_method() 定义为 MyClass 的实例方法。这种在运行时定义方法的技术称为动态方法。</p><h3 id="method-missing"><a href="#method-missing" class="headerlink" title="method_missing"></a>method_missing</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lawyer</span>;</span><span class="keyword">end</span></div><div class="line">nick = Lawyer.new</div><div class="line">nick.talk_simple</div><div class="line"></div><div class="line">=&gt; <span class="symbol">NoMethodError:</span> undefined method <span class="string">'talk_simple'</span> fro #&lt;Lawyer:0x3c848&gt;</div></pre></td></tr></table></figure><p>当调用 talk_simple() 方法时，Ruby 回到 nick 对象的类中查询它的实例方法。如果在那里找不到 talk_simple() 方法，Ruby 会沿着祖先链向上搜寻进入 Object 类，并且最终来到 Kernal 模块。由于 Ruby 在哪里都没找到 talk_simple() 方法，它只好承认自己的失败，并在 nick 对象上调用一个名为 method_missing() 的方法。Kernel#method_missing() 方法会抛出一个 NoMethodError 进行响应，这是它全部的工作。<br>你可以通过覆写它来截获无主的消息。每一个来到 method_missiong 的消息都带着被调用方法的名字，以及所有调用时传递的参数和块。<br>覆写 method_missiong() 方法使得你可以调用实际上并不存在的方法。<br>被 method_missiong() 方法处理的消息，从调用者角度看，跟普通方法没什么区别，但是实际上接受者并没有相对应的方法。这被称为一个幽灵方法。</p><p>当一个幽灵方法和一个真实方法发生名字冲突时，后者会胜出。如果不需要那个继承来的真实方法，则可以通过删除它来解决这个问题。为了安全起见，你应该在代理类中删除绝大多数继承来的方法。这就是所谓的白板类，它所拥有的方法比 Object 类还要少。<br>你可以通过两种简单的途径来删除一个方法。可以使用 Module#undeft_method 方法，它会删除所有的（包括继承来的）方法；也可以使用 Module@remove_method() 方法，它删除接受者自己的方法，而保留继承来的方法。</p><h2 id="Ch-3"><a href="#Ch-3" class="headerlink" title="Ch.3"></a>Ch.3</h2><h3 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h3><p>块会在定义时获取周围的绑定。你可以在块的内部定义额外的绑定，但是这些绑定在块结束时就会消失。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_method</span></span></div><div class="line">  <span class="keyword">yield</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">top_level_variable = <span class="number">1</span></div><div class="line">my_method <span class="keyword">do</span></div><div class="line">  top_level_variable += <span class="number">1</span></div><div class="line">  local_to_block = <span class="number">1</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">top_level_variable <span class="comment"># =&gt; 2</span></div><div class="line"></div><div class="line">local_to_block <span class="comment"># =&gt; Error</span></div></pre></td></tr></table></figure></p><p>在一些语言中，比如  Java 和 C#，有“内部作用域”的概念。在内部作用于中可以看见“外部作用域”中的变量。但 Ruby 中没有这种嵌套的作用域，它的作用域之间是截然分开的：一旦进入一个新的作用域，原先的绑定就会被替换为一组新的绑定。</p><p>准确地说，程序会在三个地方关闭前一个作用域，同时打开一个新的作用域：</p><ul><li>类定义</li><li>模块定义</li><li>方法<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">v1 = <span class="number">1</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>               <span class="comment"># 作用域门：进入 class</span></span></div><div class="line">    v2 = <span class="number">2</span></div><div class="line">    local_variables         <span class="comment"># =&gt; [:v2]</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_method</span>           <span class="comment"># 作用域门：进入 def</span></span></div><div class="line">        v3 = <span class="number">3</span></div><div class="line">        local_variables</div><div class="line">    <span class="keyword">end</span>                     <span class="comment"># 作用域门：离开 def</span></div><div class="line"></div><div class="line">    local_variables         <span class="comment"># =&gt; [:v2]</span></div><div class="line"><span class="keyword">end</span>                         <span class="comment"># 作用域门：离开 class</span></div><div class="line">obj = MyClass.new</div><div class="line">obj.my_method               <span class="comment"># =&gt; [:v3]</span></div><div class="line">obj.my_method               <span class="comment"># =&gt; [:v3]</span></div><div class="line">local_variables             <span class="comment"># =&gt; [:v1, :obj]</span></div></pre></td></tr></table></figure></li></ul><p>每个Ruby作用域包含一组绑定，并且不同的作用域之间被作用域门分隔开来：class、module 和 def。<br>如果要让一两个绑定穿越作用域门，那么可以用方法调用来代替作用域门：用一个闭包获取当前的绑定，并把这个闭包传递给该方法。你可以使用 Class.new() 方法代替 class，使用 Module.new 代替 module，以及使用 Module#define_method() 代替 def。这就形成了一个扁平作用域，它是闭包中的一个基本概念。如果在一个扁平作用域中定义了多个方法，则这些方法可以用一个作用域门进行保护，并共享绑定，这种技术称为共享作用域。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">a_scope</span></span></div><div class="line">    $var = <span class="string">"some value"</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">another_scope</span></span></div><div class="line">    $var</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">a_scope</div><div class="line">another_scope =&gt; <span class="string">"some value"</span></div></pre></td></tr></table></figure><p>全局变量（以$开头）可以在任何作用域中访问。如非必要，尽可能少使用全局变量。<br>有时可以用顶级实例变量来代替全局变量。他们是顶级 main 的实例变量。<br>只要 main 对象在扮演 self 的角色，就可以访问顶级实例变量。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@var = <span class="string">"The top-level @var"</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_method</span></span></div><div class="line">    @var</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">my_method <span class="comment"># =&gt; "The top-level <span class="doctag">@var</span>"</span></div></pre></td></tr></table></figure></p><h3 id="instance-eval"><a href="#instance-eval" class="headerlink" title="instance_eval()"></a>instance_eval()</h3><p>Object#instance_eval() 方法，它在一个对象的上下文中执行一个块。在运行时，该块的接收者会成为 self，因此它可以访问接收者的私有方法和实例变量。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></div><div class="line">        @v = <span class="number">1</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line">obj = MyClass.new</div><div class="line">obj.instance_eval <span class="keyword">do</span></div><div class="line">    <span class="keyword">self</span>             <span class="comment"># =&gt; &lt;MyClass:0x3340dc <span class="doctag">@v</span>=1&gt;</span></div><div class="line">    @v               <span class="comment"># =&gt; 1</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>洁净室仅仅是一个用来执行块的环境，它通常还会暴露若干有用的方法供块调用。</p><h3 id="可调用对象"><a href="#可调用对象" class="headerlink" title="可调用对象"></a>可调用对象</h3><p>可调用对象是可以执行的代码片段，而且它们有自己的作用域。<br>可调用对象可以有以下几种方式：</p><ul><li>块（虽然它们不是真正的“对象”，但是它们是“可调用的”）：在定义它们的作用域中执行。</li><li>proc：Proc 类的对象，跟块一样，它们也在定义自身的作用域中执行。</li><li>lambda：也是 Proc 类的对象，但是它跟普通的 proc 有细微的区别。它跟块和 proc 一样都是闭包，因此也在定义自身的作用域中执行。</li><li>方法：绑定于对象，在所绑定对象的作用域中执行。它们也可以与这个作用域解除绑定，再重新绑定到另一个对象的作用域上。</li></ul><p>不同种类的可调用对象有细微的区别。在方法和 lambda 中，return 语句从可调用对象中返回。在块和 proc 中，return 语句从定义可调用对象的原始上下文中返回。<br>另外，不同的可调用对象对传入参数数目不符有不同的反应。其中方法处理方式最严格，lambda 同样严格（它与方法相比，在某些极端情况下略为宽松），而 proc 和块则要宽松一些。<br>尽管有这些区别，还是可以将一种可调用对象转换为另外一种可调用对象的，实现这样功能的方法包括 Proc.new() 方法、Method#to_proc() 方法和 &amp; 操作符。</p><h2 id="Ch-4"><a href="#Ch-4" class="headerlink" title="Ch.4"></a>Ch.4</h2><h3 id="类定义"><a href="#类定义" class="headerlink" title="类定义"></a>类定义</h3><p>在类定义中，当前对象 self 就是正在定义的类。<br>Ruby 解释器总是追踪当前类（模块）的引用。所有使用 def 定义的方法都成为当前类的实例方法。<br>Module#class_eval 方法会在一个已存在类的上下文中执行一个块。</p><p>Ruby 解释器假定所有的实例变量都属于当前对象 self。在类定义时也是如此：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></div><div class="line">    @my_var = <span class="number">1</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>在类定义时，self 的角色由类本身担任，因此实例变量 @my_var 属于这个类。类的实例变量不同于类的对象的实例变量。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></div><div class="line">    @my_var = <span class="number">1</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">read</span>;</span> @my_var; <span class="keyword">end</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span>;</span> @my_var = <span class="number">2</span>; <span class="keyword">end</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span>;</span> @my_var; <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line">obj = MyClass.new</div><div class="line">obj.write obj.read      <span class="comment"># =&gt; 2</span></div><div class="line">MyClass.read            <span class="comment"># =&gt; 1</span></div></pre></td></tr></table></figure></p><p>类实例变量只不过属于 Class 类对象的普通实例变量而已。正因为如此，类实例变量仅仅可以被类本身所访问————而不能被类的实例或子类所访问。</p><h3 id="类变量"><a href="#类变量" class="headerlink" title="类变量"></a>类变量</h3><p>类变量与类实例变量不同，它们可以被子类或类的实例所使用。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></div><div class="line">    @@v = <span class="number">1</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><p>因为类变量并不真正属于类——它们属于类体系结构。由于 @@v 定义于 main 的上下文，它属于 main 的类 Object，所以也属于 Object 的所有后代。MyClass 继承自Object，因此它也共享了这个类变量。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@@v = <span class="number">1</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></div><div class="line">    @@v = <span class="number">2</span></div><div class="line"><span class="keyword">end</span></div><div class="line">@@v     <span class="comment"># =&gt; 2</span></div></pre></td></tr></table></figure></p><h3 id="eigenclass"><a href="#eigenclass" class="headerlink" title="eigenclass"></a>eigenclass</h3><p>Ruby 有一种特殊的基于 class 关键字的语法，它可以让你进入该 eigenclass 的作用域。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">obj = Object.new</div><div class="line">eigenclass = <span class="class"><span class="keyword">class</span> &lt;&lt; obj</span></div><div class="line">    <span class="keyword">self</span></div><div class="line"><span class="keyword">end</span></div><div class="line">eigenclass.<span class="keyword">class</span> <span class="comment"># =&gt; Class</span></div></pre></td></tr></table></figure></p><p>每个 eigenclass 只有一个实例，并且不能被继承。更重要的是，eigenclass 是一个对象的单件方法的存活之所。</p><p>类方法定义的方式<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">my_method1</span>;</span><span class="keyword">end</span> <span class="comment"># 方法1</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">MyClass</span>.<span class="title">my_method2</span>;</span><span class="keyword">end</span> <span class="comment"># 方法2</span></div><div class="line">    <span class="class"><span class="keyword">class</span> &lt;&lt; self</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">my_method3</span>;</span><span class="keyword">end</span> <span class="comment"># 方法3</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">a_method</span></span></div><div class="line">        <span class="string">'C#a_method()'</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line">cladd D &lt; C; <span class="keyword">end</span></div><div class="line">obj = D.new</div><div class="line">obj.a_method <span class="comment"># =&gt; 'C#a_method()'</span></div><div class="line"></div><div class="line"><span class="comment"># 辅助方法</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Object</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eigenclass</span></span></div><div class="line">        <span class="class"><span class="keyword">class</span> &lt;&lt; self;</span> <span class="keyword">self</span>; <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> &lt;&lt; obj</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">a_singleton_method</span></span></div><div class="line">        <span class="string">'obj#a_singleton_method()'</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure><p>有 eigenclass 的方法查找<br><img src="/img/singleton_method.jpg" alt="singleton_method.jpg-88.2kB"></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></div><div class="line">    <span class="class"><span class="keyword">class</span> &lt;&lt; self</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">a_class_method</span></span></div><div class="line">            <span class="string">'C.a_class_method()'</span></div><div class="line">        <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">C.eigenclass                    <span class="comment"># =&gt; #&lt;Class:C&gt;</span></div><div class="line">D.eigenclass                    <span class="comment"># =&gt; #&lt;Class:D&gt;</span></div><div class="line">D.eigenclass.superclass         <span class="comment"># =&gt; #&lt;Class:C&gt;</span></div><div class="line">C.eigenclass.superclass         <span class="comment"># =&gt; #&lt;Class:Object&gt;</span></div></pre></td></tr></table></figure><p>类的 eigenclass<br><img src="/img/class_singleton_method.jpg" alt="class_singleton_method.jpg-113.5kB"></p><p>如果把eigenclass、普通类和模块放到一起，Ruby  对象模型可以总结为 7 条规则：</p><ol><li>只有一种对象——要么是普通对象，要么是模块。</li><li>只有一种模块——可以是普通模块、类、eigenclass 或代理类。</li><li>只有一个方法，它存在于一种模块中——通常是类中。</li><li>每个对象（包括类）都有自己的“真正的类”——要么是普通类，要么是 eigenclass。</li><li>除了 BasicObject 类无超类外，每个类有且只有一个超类。这意味着从任何类只有一条向上直到 BasicObject 的祖先链。</li><li>一个对象的 eigenclass 的超类是这个对象的类；一个类的 eigenclass 的超类是这个类的超类的 eigenclass。</li><li>当调用一个方法，Ruby 先向“右”迈一步进入接收者真正的类，然后向“上”进入祖先链。这就是 Ruby 查找方法的全部内容。</li></ol><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">MyModule</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_method</span>;</span> <span class="string">"hello"</span>;<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment"># 类扩展</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></div><div class="line">    <span class="class"><span class="keyword">class</span> &lt;&lt; self</span></div><div class="line">        <span class="keyword">include</span> MyMoudle</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line">MyClass.my_method <span class="comment"># =&gt; "hello"</span></div><div class="line"></div><div class="line"><span class="comment"># 对象扩展</span></div><div class="line">obj = Object.new</div><div class="line"><span class="class"><span class="keyword">class</span> &lt;&lt; obj</span></div><div class="line">    <span class="keyword">include</span> MyMoudl</div><div class="line"><span class="keyword">end</span></div><div class="line">obj.my_method <span class="comment"># =&gt; "hello"</span></div></pre></td></tr></table></figure><p>Object#entend() 在接收者 eigenclass 中包括模块的快捷方式。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></div><div class="line">    extend MyMoule</div><div class="line"><span class="keyword">end</span></div><div class="line">MyClass.my_method <span class="comment"># =&gt; "hello"</span></div><div class="line">obj.extend MyMoule</div><div class="line">obj.my_method <span class="comment"># =&gt; "hello"</span></div></pre></td></tr></table></figure></p><h2 id="Ch-5"><a href="#Ch-5" class="headerlink" title="Ch.5"></a>Ch.5</h2><h3 id="eval"><a href="#eval" class="headerlink" title="eval()"></a>eval()</h3><p>Kernel#eval() 方法会执行字符串中的代码，并返回执行结果。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">array = [<span class="number">10</span>, <span class="number">20</span>]</div><div class="line">element = <span class="number">30</span></div><div class="line">eval(<span class="string">"array &lt;&lt; element"</span>) <span class="comment"># =&gt; [10, 20, 30]</span></div></pre></td></tr></table></figure></p><p>Binding 就是一个用对象表示的完整作用域。你可以通过创建 Binding 对象来捕获并带走当前的作用域。接下来，你还可以通过 eval() 方法、instance_eval() 方法或 class_eval() 方法，在 Binding 对象所携带的作用域中执行代码。可以使用 Kernel#bingding() 方法来创建 Bingding 对象。</p><h4 id="污染对象和安全级别"><a href="#污染对象和安全级别" class="headerlink" title="污染对象和安全级别"></a>污染对象和安全级别</h4><p>Ruby 会自动把不安全的对象——尤其是从外部传入的对象——标记为被污染的。污染对象包括程序从Web表单、文件和命令行读入的字符串，甚至包括系统变量。每次从污染字符串运算而来的新字符串，也是被污染的。通过调用 tainted?() 方法来判断类是不是被污染了。<br>当设置一个安全级别（可以通过给$SAFE全局变量赋值来实现）时，就禁止了某些特定的潜在危险操作。有五个安全级别可供选择，从默认的 0（这里是一个“嬉皮士公社”，在这儿你可以不受约束，也可以格式化硬盘）到 4（这里是“军事管辖区”，在这儿你甚至不能自由地退出程序）。例如，在安全级别 2 上，会禁止绝大多数文件相关工作。值得注意的是，在任何大于 0 的安全级别上，Ruby 都会拒绝执行污染的字符串。</p><h3 id="类扩展混入"><a href="#类扩展混入" class="headerlink" title="类扩展混入"></a>类扩展混入</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Merb::Cache::CacheMixin</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span></div><div class="line">        base.extend(ClassMethods)</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">module</span> <span class="title">ClassMethods</span></span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">cache</span><span class="params">(*actions)</span></span></div><div class="line">            <span class="comment"># ...</span></div></pre></td></tr></table></figure><p>Merb::Cache::CacheMixin  既充当了混入，也充当了内部模块的命名空间，这个内部模块被恰当地命名为 ClassMethods，并定义了像 cache() 这样的类宏。当包含 CacheMixin 时，就会触发一系列事件，如下：<br>• Ruby 调用一个钩子方法：included() 方法。<br>• 这个钩子方法接着会转而处理包含模块的类（有时会称其为包含者（inclusor），或者像在这里一样称为 base），并用 ClassMethods 模块扩展它。<br>• extend() 方法会把 ClassMethods 模块中的方法包含到包含者的 eigenclass 中。结果就是，cache() 等实例方法会混入到该类的 eigenclass 中，实际上成为包含者的类方法。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Ch-1&quot;&gt;&lt;a href=&quot;#Ch-1&quot; class=&quot;headerlink&quot; title=&quot;Ch.1&quot;&gt;&lt;/a&gt;Ch.1&lt;/h2&gt;&lt;h3 id=&quot;打开类&quot;&gt;&lt;a href=&quot;#打开类&quot; class=&quot;headerlink&quot; title=&quot;打开类&quot;&gt;&lt;/a&gt;打开类&lt;/h3&gt;&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;D&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;x&lt;/span&gt;;&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;x&#39;&lt;/span&gt;; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;D&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;y&lt;/span&gt;;&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;y&#39;&lt;/span&gt;; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;obj = D.new&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;obj.x &lt;span class=&quot;comment&quot;&gt;# =&amp;gt; &#39;x&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;obj.y &lt;span class=&quot;comment&quot;&gt;# =&amp;gt; &#39;y&#39;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在上面的代码中，当第一次提及 class D 时，还没有一个叫做 D 的类存在。因此，Ruby 开始着手定义这个类，并定义 x() 方法。在第二次提及 D 类时，它已经存在，Ruby 就不用再定义它了。Ruby 只要重新打开这个已经存在的类，并为之定义 y() 方法。从某种意义上说，Rub y的 class 关键字更像是一个作用域操作符而不是类型声明语句。它的确可以创建一个还不存在的类，不过也可以把这看成是一种副作用。对于 class 关键字，其核心任务是把你带到类的上下文中，让你可以在其中定义方法。&lt;/p&gt;
    
    </summary>
    
      <category term="读书笔记" scheme="http://kaywu.xyz/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="读书笔记" scheme="http://kaywu.xyz/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>探索 pointerIndex out of range</title>
    <link href="http://kaywu.xyz/2016/09/25/pointer-index-out-of-range/"/>
    <id>http://kaywu.xyz/2016/09/25/pointer-index-out-of-range/</id>
    <published>2016-09-25T03:50:53.000Z</published>
    <updated>2017-09-10T08:13:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近 App 里报了一个奇怪的 Exception。为什么说奇怪呢，因为它发生的概率不是很大，但每天总有那么几个。这种非必现的问题，解决起来最是麻烦。查了下代码，发现是 <code>event.getY()</code> 报错，我刚看到的反应是：纳尼，这里都能报错？网上查找了下解决方案，大致都是在  <code>onTouchEvent</code> 里面或外面包一层 try…catch。能解决问题，可惜不够优雅。 于是花了些时间研究下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalArgumentException: pointerIndex out of range</div><div class="line">    at android.view.MotionEvent.nativeGetAxisValue(Native Method)</div><div class="line">    at android.view.MotionEvent.getY(MotionEvent.java:<span class="number">1994</span>)</div><div class="line">    at com.kay.example.DemoView.onTouchEvent(HomeView.java:<span class="number">184</span>)</div><div class="line">    at android.view.View.dispatchTouchEvent(View.java:<span class="number">7714</span>)</div><div class="line">    at android.view.ViewGroup.dispatchTransformedTouchEvent(ViewGroup.java:<span class="number">2210</span>)</div><div class="line">    at android.view.ViewGroup.dispatchTouchEvent(ViewGroup.java:<span class="number">1945</span>)</div></pre></td></tr></table></figure><h2 id="探索"><a href="#探索" class="headerlink" title="探索"></a>探索</h2><p>这种非必现的问题，第一步要找到能重现问题的场景。于是我就拼命地戳那个报错的 View，在不懈努力之下，还真重现了几次。异常的栈跟上面是一致的，看来 <code>event.getY()</code> 真能出错。<br>如果 <code>event.getY()</code> 这种基础的方法都能出错，那么系统的控件是如何防止这个错误的呢。<br>查看了 <code>NestedScrollView</code> 的源码，发现它的 <code>onTouchEvent</code> 的处理果然是有门道的。<br><a id="more"></a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NestedScrollView#onTouchEvent</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">switch</span> (actionMasked) &#123;</div><div class="line">    <span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        mActivePointerId = MotionEventCompat.getPointerId(ev, <span class="number">0</span>);</div><div class="line">        startNestedScroll(ViewCompat.SCROLL_AXIS_VERTICAL);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> activePointerIndex = MotionEventCompat.findPointerIndex(ev,</div><div class="line">                mActivePointerId);</div><div class="line">        <span class="keyword">if</span> (activePointerIndex == -<span class="number">1</span>) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"Invalid pointerId="</span> + mActivePointerId + <span class="string">" in onTouchEvent"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">float</span> y = event.getY(activePointerIndex);</div><div class="line">        <span class="comment">// ...</span></div></pre></td></tr></table></figure></p><p>在报错的 View 中，是直接通过 <code>event.getY()</code> 来获取到纵坐标的值。而 <code>NestedScrollView</code> 先保存了原先 MotionEvent 的 PointerId，再通过 PointerId 查找到 Index，并判断是否有效，最终通过 <code>event.getY(activePointerIndex)</code> 获取纵坐标的值。<br>查看源码发现，<code>event.getY()</code> 相当于 <code>event.getY(0)</code>，也就是说两者的差别在于对 Index 的获取。那么 Index 和 Id 两者有什么区别呢？</p><h2 id="Index-vs-ID"><a href="#Index-vs-ID" class="headerlink" title="Index vs ID"></a>Index vs ID</h2><p>以下这段来自 <a href="http://android-developers.blogspot.ru/2010/06/making-sense-of-multitouch.html" target="_blank" rel="external">Making Sense of Multitouch</a>。</p><p>At a higher level, touchscreen data from a snapshot in time may not be immediately useful since touch gestures involve motion over time spanning many motion events. A pointer index does not necessarily match up across complex events, it only indicates the data’s position within the MotionEvent. However this is not work that your app has to do itself. Each pointer also has an ID mapping that stays persistent across touch events. You can retrieve this ID for each pointer using MotionEvent.getPointerId(index) and find an index for a pointer ID using MotionEvent.findPointerIndex(id).</p><p>简单的说，Index 只是表示存储在 MotionEvent 中数据的位置，在事件中不一定保持一致。而 ID 在 Touch 事件中是保持一致的。因此我们需要先保存 PointerId 然后再通过它来找到对应的 Index 来获取相应的坐标数据。</p><p>看来得多看看系统源码，能少爬多少坑。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://android-developers.blogspot.ru/2010/06/making-sense-of-multitouch.html" target="_blank" rel="external">Making Sense of Multitouch</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近 App 里报了一个奇怪的 Exception。为什么说奇怪呢，因为它发生的概率不是很大，但每天总有那么几个。这种非必现的问题，解决起来最是麻烦。查了下代码，发现是 &lt;code&gt;event.getY()&lt;/code&gt; 报错，我刚看到的反应是：纳尼，这里都能报错？网上查找了下解决方案，大致都是在  &lt;code&gt;onTouchEvent&lt;/code&gt; 里面或外面包一层 try…catch。能解决问题，可惜不够优雅。 于是花了些时间研究下。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;java.lang.IllegalArgumentException: pointerIndex out of range&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.MotionEvent.nativeGetAxisValue(Native Method)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.MotionEvent.getY(MotionEvent.java:&lt;span class=&quot;number&quot;&gt;1994&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at com.kay.example.DemoView.onTouchEvent(HomeView.java:&lt;span class=&quot;number&quot;&gt;184&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.View.dispatchTouchEvent(View.java:&lt;span class=&quot;number&quot;&gt;7714&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewGroup.dispatchTransformedTouchEvent(ViewGroup.java:&lt;span class=&quot;number&quot;&gt;2210&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    at android.view.ViewGroup.dispatchTouchEvent(ViewGroup.java:&lt;span class=&quot;number&quot;&gt;1945&lt;/span&gt;)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;探索&quot;&gt;&lt;a href=&quot;#探索&quot; class=&quot;headerlink&quot; title=&quot;探索&quot;&gt;&lt;/a&gt;探索&lt;/h2&gt;&lt;p&gt;这种非必现的问题，第一步要找到能重现问题的场景。于是我就拼命地戳那个报错的 View，在不懈努力之下，还真重现了几次。异常的栈跟上面是一致的，看来 &lt;code&gt;event.getY()&lt;/code&gt; 真能出错。&lt;br&gt;如果 &lt;code&gt;event.getY()&lt;/code&gt; 这种基础的方法都能出错，那么系统的控件是如何防止这个错误的呢。&lt;br&gt;查看了 &lt;code&gt;NestedScrollView&lt;/code&gt; 的源码，发现它的 &lt;code&gt;onTouchEvent&lt;/code&gt; 的处理果然是有门道的。&lt;br&gt;
    
    </summary>
    
      <category term="Android" scheme="http://kaywu.xyz/categories/Android/"/>
    
    
      <category term="Android" scheme="http://kaywu.xyz/tags/Android/"/>
    
  </entry>
  
</feed>
